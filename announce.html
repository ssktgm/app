<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野球アナウンスシート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- *** 修正 *** -->
    <!-- 'defer' 属性を <script> タグに正しく追加しました -->
    <!-- これにより、HTMLの読み込み完了後にAlpine.jsが実行されるようになります -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        /* Alpine.jsの初期化中（読み込み中）の要素を隠す */
        [x-cloak] { display: none !important; }
        /* タブの基本的なスタイル */
        .tab-button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280; /* gray-500 */
        }
        .tab-button.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        .subtab-button {
            padding: 0.25rem 0.75rem;
            cursor: pointer;
            border: 1px solid #d1d5db; /* gray-300 */
            color: #4b5563; /* gray-600 */
            background-color: white;
            border-radius: 0.375rem; /* rounded-md */
        }
        .subtab-button.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-color: #3b82f6; /* blue-500 */
        }
        /* 交代フォームのセクションスタイル */
        .change-section {
            background-color: #f9fafb; /* gray-50 */
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans" x-data="appData()" x-init="init()">

    <div class="max-w-7xl mx-auto min-h-screen bg-white shadow-lg">
        
        <!-- ヘッダー -->
        <header class="bg-blue-600 text-white p-6 shadow-md">
            <h1 class="text-3xl font-bold">野球アナウンスシート</h1>
            <p class="text-xl">ありんこアントス</p>
        </header>

        <!-- タブナビゲーション -->
        <nav class="flex border-b border-gray-300 bg-gray-50">
            <button @click="activeTab = 'master'" :class="{'active': activeTab === 'master'}" class="tab-button">
                選手マスタ管理
            </button>
            <button @click="activeTab = 'setup'" :class="{'active': activeTab === 'setup'}" class="tab-button">
                試合設定
            </button>
            <button @click="activeTab = 'sheet'" :class="{'active': activeTab === 'sheet'}" class="tab-button">
                アナウンスシート
            </button>
        </nav>

        <!-- メインコンテンツエリア -->
        <main class="p-4 md:p-8">

            <!-- 通知メッセージ -->
            <div x-show="message.text" x-cloak
                 class="p-4 mb-4 rounded-md"
                 :class="{
                     'bg-green-100 border border-green-400 text-green-700': message.type === 'success',
                     'bg-red-100 border border-red-400 text-red-700': message.type === 'error'
                 }"
                 x-transition>
                <span x-text="message.text"></span>
            </div>

            <!-- 1. 選手マスタ管理タブ -->
            <div x-show="activeTab === 'master'" x-cloak>
                <h2 class="text-2xl font-semibold mb-4">選手マスタ管理</h2>
                
                <!-- 選手追加フォーム -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-6 border border-gray-200">
                    <h3 class="text-xl font-medium mb-4">選手登録</h3>
                    <form @submit.prevent="addPlayer" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input x-model="newPlayer.name" type="text" placeholder="氏名" required class="col-span-1 md:col-span-1 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <input x-model="newPlayer.furigana" type="text" placeholder="ふりがな" class="col-span-1 md:col-span-1 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <input x-model.number="newPlayer.number" type="number" placeholder="背番号" class="col-span-1 md:col-span-1 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <input x-model="newPlayer.grade" type="text" placeholder="学年 (例: 5年)" class="col-span-1 md:col-span-1 p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button type="submit" class="col-span-1 md:col-span-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-150">
                            登録
                        </button>
                    </form>
                </div>

                <!-- データ管理 (インポート/エクスポート) -->
                <div class="flex items-center space-x-2 mb-6">
                    <button @click="exportPlayers" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150">
                        JSONダウンロード
                    </button>
                    <input type="file" id="importFile" @change="importPlayers($event)" accept="application/json" class="hidden">
                    <label for="importFile" class="cursor-pointer bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md transition duration-150">
                        JSONアップロード
                    </label>
                </div>

                <!-- 選手一覧 -->
                <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200 bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">背番号</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">氏名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ふりがな</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学年</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="player in players" :key="player.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="player.number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800" x-text="player.name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="player.furigana"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="player.grade"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="deletePlayer(player.id)" class="text-red-600 hover:text-red-900">削除</button>
                                    </td>
                                </tr>
                            </template>
                            <template x-if="players.length === 0">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">選手が登録されていません。</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 2. 試合設定タブ -->
            <div x-show="activeTab === 'setup'" x-cloak>
                <h2 class="text-2xl font-semibold mb-4">試合設定</h2>

                <!-- メンバー設定 (先に) -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
                    <h3 class="text-xl font-medium mb-4">1. メンバー設定</h3>
                    
                    <!-- スターティングメンバー -->
                    <h4 class="text-lg font-medium text-gray-800 mb-3">スターティングメンバー (1〜9番)</h4>
                    <div class="space-y-3 mb-6">
                        <template x-for="(starter, i) in game.starters" :key="i">
                            <div class="grid grid-cols-12 gap-2 items-center">
                                <span class="col-span-1 text-sm font-medium text-gray-700 text-right pr-2" x-text="`${i + 1}番`"></span>
                                <!-- 選手選択 -->
                                <div class="col-span-6 md:col-span-5">
                                    <select x-model="starter.playerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">選手を選択</option>
                                        <template x-for="player in availablePlayers(i)" :key="i + '-' + player.id">
                                            <option :value="player.id" x-text="`${player.number || ' '}. ${player.name}`"></option>
                                        </template>
                                    </select>
                                </div>
                                <!-- 守備位置選択 -->
                                <div class="col-span-5 md:col-span-4">
                                    <select x-model="starter.position" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">守備位置</option>
                                        <template x-for="pos in availablePositions(i)" :key="i + '-' + pos.id">
                                            <option :value="pos.id" x-text="`${pos.id}.${pos.name}`"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- 控え選手 -->
                    <h4 class="text-lg font-medium text-gray-800 mb-3">控え選手</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <template x-for="player in benchPlayers" :key="player.id">
                            <label class="flex items-center p-3 border rounded-md bg-white shadow-sm hover:bg-gray-50 transition">
                                <input type="checkbox" x-model="game.bench" :value="player.id" class="form-checkbox text-blue-600 h-5 w-5 rounded focus:ring-blue-500">
                                <span class="ml-3 text-sm text-gray-700" x-text="`${player.number || ' '}. ${player.name}`"></span>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- 試合情報 (次に) -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200">
                    <h3 class="text-xl font-medium mb-4">2. 試合情報</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 対戦相手 -->
                        <div>
                            <label for="opponentName" class="block text-sm font-medium text-gray-700 mb-1">対戦相手</label>
                            <input type="text" id="opponentName" x-model="game.opponentName" placeholder="対戦相手チーム名" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 先攻/後攻 -->
                        <fieldset>
                            <legend class="block text-sm font-medium text-gray-700 mb-1">先攻 / 後攻</legend>
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center">
                                    <input type="radio" x-model="game.myTeamAttack" value="first" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">ありんこアントス (先攻)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" x-model="game.myTeamAttack" value="second" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">ありんこアントス (後攻)</span>
                                </label>
                            </div>
                        </fieldset>

                        <!-- 一塁側/三塁側 -->
                        <fieldset>
                            <legend class="block text-sm font-medium text-gray-700 mb-1">一塁側 / 三塁側</legend>
                            <div class="flex items-center space-x-4 mt-2">
                                <label class="flex items-center">
                                    <input type="radio" x-model="game.myTeamSide" value="firstBase" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">ありんこアントス (一塁側)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" x-model="game.myTeamSide" value="thirdBase" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">ありんこアントス (三塁側)</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>

                    <!-- 審判員 -->
                    <div class="mt-6">
                        <h4 class="text-lg font-medium text-gray-800 mb-3">審判員</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <input x-model="game.umpires.plate" type="text" placeholder="球審" class="p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <input x-model="game.umpires.first" type="text" placeholder="一塁" class="p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <input x-model="game.umpires.second" type="text" placeholder="二塁" class="p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <input x-model="game.umpires.third" type="text" placeholder="三塁" class="p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <!-- *** 新規 *** : 試合設定の保存 -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6" x-show="localStorageAvailable" x-cloak>
                    <h3 class="text-xl font-medium mb-4">3. 試合設定の保存・復元</h3>
                    <p class="text-sm text-gray-600 mb-4">現在の試合設定（スタメン、対戦相手など）をブラウザに保存します。</p>
                    <div class="flex flex-wrap gap-2">
                        <button @click="saveGameSettings" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md transition">
                            現在の試合設定を保存
                        </button>
                        <button @click="loadGameSettings" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition" :disabled="!game.savedGameExists">
                            保存した設定を読み込む
                        </button>
                        <button @click="clearGameSettings" class="text-red-600 hover:text-red-900 text-sm py-2 px-4" :disabled="!game.savedGameExists">
                            保存データをクリア
                        </button>
                    </div>
                </div>

                <!-- 設定完了ボタン -->
                <div class="mt-8 flex justify-end">
                    <button @click="confirmLineup" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-150 text-lg">
                        試合開始 (アナウンスシートへ)
                    </button>
                </div>
            </div>

            <!-- 3. アナウンスシートタブ -->
            <div x-show="activeTab === 'sheet'" x-cloak>
                
                <!-- サブタブ -->
                <div class="flex space-x-2 mb-6">
                    <button @click="sheetSubTab = 'progress'" :class="{'active': sheetSubTab === 'progress'}" class="subtab-button">
                        試合進行
                    </button>
                    <button @click="sheetSubTab = 'change'" :class="{'active': sheetSubTab === 'change'}" class="subtab-button">
                        選手交代
                    </button>
                </div>

                <!-- 3a. 試合進行 サブタブ -->
                <div x-show="sheetSubTab === 'progress'">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- 試合状況カラム -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="text-xl font-semibold mb-2">試合状況</h3>
                            
                            <!-- スコアボード -->
                            <div class="bg-gray-800 text-white p-4 rounded-lg shadow-md">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-lg" x-text="game.myTeamAttack === 'first' ? 'ありんこアントス' : (game.opponentName || '対戦相手')"></span>
                                    <span class="text-2xl font-bold" x-text="game.myTeamAttack === 'first' ? progress.myTeamScore : progress.opponentScore"></span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg" x-text="game.myTeamAttack === 'second' ? 'ありんこアントス' : (game.opponentName || '対戦相手')"></span>
                                    <span class="text-2xl font-bold" x-text="game.myTeamAttack === 'second' ? progress.myTeamScore : progress.opponentScore"></span>
                                </div>
                                <div class="text-center mt-3 pt-2 border-t border-gray-600">
                                    <span class="text-xl" x-text="`${progress.inning}回 ${progress.topOrBottom === 'top' ? '表' : '裏'}`"></span>
                                </div>
                            </div>
                            
                            <!-- イニング操作 -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="font-medium mb-2">イニング操作</h4>
                                <div class="flex items-center space-x-2">
                                    <button @click="prevInningState" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition">-</button>
                                    <span class="flex-grow text-center text-lg font-medium" x-text="`${progress.inning}回 ${progress.topOrBottom === 'top' ? '表' : '裏'}`"></span>
                                    <button @click="nextInningState" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md transition">+</button>
                                </div>
                            </div>

                            <!-- スコア操作 -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="font-medium mb-2">スコア操作</h4>
                                <div class="flex justify-between items-center mb-2">
                                    <span>ありんこアントス:</span>
                                    <div class="flex items-center space-x-2">
                                        <button @click="progress.myTeamScore = Math.max(0, progress.myTeamScore - 1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition">-</button>
                                        <span class="text-lg w-8 text-center" x-text="progress.myTeamScore"></span>
                                        <button @click="progress.myTeamScore++" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition">+</button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span x-text="game.opponentName || '対戦相手'"></span>
                                    <div class="flex items-center space-x-2">
                                        <button @click="progress.opponentScore = Math.max(0, progress.opponentScore - 1)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition">-</button>
                                        <span class="text-lg w-8 text-center" x-text="progress.opponentScore"></span>
                                        <button @click="progress.opponentScore++" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded-md transition">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- アナウンス生成カラム -->
                        <div class="md:col-span-2 space-y-4">
                            <h3 class="text-xl font-semibold mb-2">アナウンス生成</h3>
                            
                            <!-- 試合前 -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="text-lg font-medium mb-3">試合前</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <button @click="generatePreGameLineupCall" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">先攻後攻決め</button>
                                    <button @click="generateKnockCall('second')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">シートノック (後攻)</button>
                                    <button @click="generateKnockCall('first')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">シートノック (先攻)</button>
                                    <button @click="generateStartingMemberCall('ants')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">スタメン (アントス)</button>
                                    <button @click="generateStartingMemberCall('opponent')" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">スタメン (相手)</button>
                                    <button @click="generateUmpireCall" class="bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-md transition">審判紹介</button>
                                </div>
                            </div>
                            
                            <!-- イニング -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="text-lg font-medium mb-3">イニング</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <button @click="generateFieldCall()" class="bg-green-100 hover:bg-green-200 text-green-800 text-sm py-2 px-3 rounded-md transition">守備紹介</button>
                                    <button @click="generateInningAttackCall()" class="bg-green-100 hover:bg-green-200 text-green-800 text-sm py-2 px-3 rounded-md transition">打順アナウンス</button>
                                    <button @click="generateInningScoreCall()" class="bg-green-100 hover:bg-green-200 text-green-800 text-sm py-2 px-3 rounded-md transition">得点アナウンス</button>
                                </div>
                            </div>

                            <!-- 試合終了 -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="text-lg font-medium mb-3">試合終了</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    <button @click="generateGameEndCall()" class="bg-red-100 hover:bg-red-200 text-red-800 text-sm py-2 px-3 rounded-md transition">試合終了</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3b. 選手交代 サブタブ -->
                <div x-show="sheetSubTab === 'change'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- 左カラム: スタメン・控え -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4">現在のラインナップ</h3>
                            
                            <!-- スタメン -->
                            <div class="bg-white p-4 rounded-lg shadow border mb-6">
                                <h4 class="text-lg font-medium mb-3">スターティングメンバー</h4>
                                <ul class="divide-y divide-gray-200">
                                    <template x-for="(starter, i) in lineup.starters" :key="i">
                                        <li class="py-2 flex justify-between items-center">
                                            <span class="font-medium" x-text="`${i + 1}番`"></span>
                                            <span class="text-gray-800" x-text="getPlayerName(starter.playerId) || '未設定'"></span>
                                            <span class="text-gray-600 text-sm" x-text="getPositionName(starter.position) || '未設定'"></span>
                                            <span class="text-gray-500 text-sm w-12 text-right" x-text="`背番号 ${getPlayerNumber(starter.playerId) || '-'}`"></span>
                                        </li>
                                    </template>
                                </ul>
                            </div>

                            <!-- 控え -->
                            <div class="bg-white p-4 rounded-lg shadow border">
                                <h4 class="text-lg font-medium mb-3">控え選手</h4>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="playerId in lineup.bench" :key="playerId">
                                        <span class="bg-gray-100 text-gray-800 text-sm font-medium px-3 py-1 rounded-full" x-text="`${getPlayerNumber(playerId) || '-'} ${getPlayerName(playerId)}`"></span>
                                    </template>
                                    <template x-if="lineup.bench.length === 0">
                                        <span class="text-gray-500 text-sm">控え選手はいません。</span>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- 右カラム: 交代フォーム -->
                        <div class="space-y-6">
                            <h3 class="text-xl font-semibold mb-4">交代アナウンス</h3>

                            <!-- 守備位置の交代 -->
                            <div class="change-section">
                                <h4 class="text-lg font-medium mb-3">守備位置の交代</h4>
                                <p class="text-sm text-gray-600 mb-2">例: 4-1-5-2 (セカンド→ピッチャー→サード→キャッチャー→セカンド)</p>
                                <div class="flex space-x-2">
                                    <input type="text" x-model="changeForms.positionChange" placeholder="例: 4-1-5-2" class="flex-grow p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <button @click="generatePositionChange" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition">生成</button>
                                </div>
                            </div>

                            <!-- 選手の交代 (守備) -->
                            <div class="change-section">
                                <h4 class="text-lg font-medium mb-3">選手の交代 (守備から)</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">交代する選手 (OUT)</label>
                                        <select x-model="changeForms.playerChange.outPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(スタメンから選択)</option>
                                            <template x-for="starter in lineup.starters" :key="starter.playerId">
                                                <option :value="starter.playerId" x-text="`${getPositionName(starter.position) || '不明'}: ${getPlayerName(starter.playerId)}`"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">入る選手 (IN)</label>
                                        <select x-model="changeForms.playerChange.inPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(控えから選択)</option>
                                            <template x-for="playerId in lineup.bench" :key="playerId">
                                                <option :value="playerId" x-text="getPlayerName(playerId)"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <select x-model="changeForms.playerChange.newPosition" class="flex-grow p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">(入るポジション)</option>
                                        <template x-for="pos in positions" :key="pos.id">
                                            <option :value="pos.id" x-text="pos.name"></option>
                                        </template>
                                    </select>
                                    <button @click="generatePlayerChange" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition">生成</button>
                                </div>
                            </div>
                            
                            <!-- 代打 -->
                            <div class="change-section">
                                <h4 class="text-lg font-medium mb-3">代打</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">交代する選手 (OUT)</label>
                                        <select x-model="changeForms.pinchHitter.outPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(スタメンから選択)</option>
                                            <template x-for="starter in lineup.starters" :key="starter.playerId">
                                                <option :value="starter.playerId" x-text="`${getBattingOrder(starter.playerId)}番: ${getPlayerName(starter.playerId)}`"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">代打の選手 (IN)</label>
                                        <select x-model="changeForms.pinchHitter.inPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(控えから選択)</option>
                                            <template x-for="playerId in lineup.bench" :key="playerId">
                                                <option :value="playerId" x-text="getPlayerName(playerId)"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                                <button @click="generatePinchHitter" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition">代打アナウンス生成</button>
                            </div>

                            <!-- 代走 -->
                            <div class="change-section">
                                <h4 class="text-lg font-medium mb-3">代走</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">交代する走者 (OUT)</label>
                                        <select x-model="changeForms.pinchRunner.outPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(選手を選択)</option>
                                            <!-- 代走はスタメン/控え関係なく交代可能性があるため全員から選ぶ -->
                                            <template x-for="player in players" :key="player.id">
                                                <option :value="player.id" x-text="player.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">代走の選手 (IN)</label>
                                        <select x-model="changeForms.pinchRunner.inPlayerId" class="w-full p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">(控えから選択)</option>
                                            <template x-for="playerId in lineup.bench" :key="playerId">
                                                <option :value="playerId" x-text="getPlayerName(playerId)"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <select x-model="changeForms.pinchRunner.base" class="flex-grow p-2 border rounded-md bg-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="一">一塁走者</option>
                                        <option value="二">二塁走者</option>
                                        <option value="三">三塁走者</option>
                                    </select>
                                    <button @click="generatePinchRunner" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition">代走アナウンス生成</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 共通: アナウンス結果表示 -->
                <div x-show="announcement" x-cloak class="mt-8">
                    <h3 class="text-xl font-semibold mb-3">アナウンス原稿</h3>
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-6 rounded-lg shadow-md">
                        <textarea x-model="announcement" rows="10" class="w-full p-3 border border-yellow-300 rounded-md bg-white focus:ring-yellow-500 focus:border-yellow-500 text-lg font-mono leading-relaxed"></textarea>
                        <button @click="copyToClipboard(announcement)" class="mt-3 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md transition text-sm">
                            クリップボードにコピー
                        </button>
                    </div>
                </div>

            </div> <!-- End of 'sheet' tab -->

        </main>
    </div>

    <!-- Alpine.jsデータとロジック -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                // --- 状態管理 ---
                activeTab: 'master', // 'master', 'setup', 'sheet'
                sheetSubTab: 'progress', // 'progress', 'change'
                message: { text: '', type: 'success' }, // { text, type }
                localStorageAvailable: false, 
                
                // --- データ ---
                players: [], // 選手マスタ
                newPlayer: { name: '', furigana: '', number: null, grade: '' },
                positions: [
                    { id: '1', name: 'ピッチャー' }, { id: '2', name: 'キャッチャー' }, { id: '3', name: 'ファースト' },
                    { id: '4', name: 'セカンド' }, { id: '5', name: 'サード' }, { id: '6', name: 'ショート' },
                    { id: '7', name: 'レフト' }, { id: '8', name: 'センター' }, { id: '9', name: 'ライト' }
                ],
                
                // --- 試合設定データ ---
                game: {
                    opponentName: '',
                    myTeamAttack: 'first', // 'first', 'second'
                    myTeamSide: 'firstBase', // 'firstBase', 'thirdBase'
                    umpires: { plate: '', first: '', second: '', third: '' },
                    starters: Array(9).fill().map(() => ({ playerId: '', position: '' })),
                    bench: [], // 控え選手のIDリスト
                    started: false,
                    savedGameExists: false // *** 新規 *** 保存されたデータがあるか
                },
                
                // --- アナウンスシート用データ ---
                lineup: { // 試合開始時に game からコピー
                    starters: [],
                    bench: []
                },
                progress: { // 試合進行
                    inning: 1,
                    topOrBottom: 'top', // 'top' (表), 'bottom' (裏)
                    myTeamScore: 0,
                    opponentScore: 0,
                    battingOrderIndex: { // 0-8
                        first: 0, // 先攻チームの打順
                        second: 0 // 後攻チームの打順
                    }
                },
                changeForms: { // 交代用フォーム
                    positionChange: '',
                    playerChange: { outPlayerId: '', inPlayerId: '', newPosition: '' },
                    pinchHitter: { outPlayerId: '', inPlayerId: '' },
                    pinchRunner: { outPlayerId: '', inPlayerId: '', base: '一' }
                },
                announcement: '', // 生成されたアナウンス文

                // --- 初期化 ---
                init() {
                    this.checkLocalStorage(); 
                    this.loadPlayers();
                    // *** 修正 *** : ページロード時に保存された試合設定があるか確認する
                    if (this.localStorageAvailable) {
                        try {
                            const savedGame = localStorage.getItem('baseballApp_gameSettings');
                            if (savedGame) {
                                this.game.savedGameExists = true;
                            }
                        } catch(e) {
                            console.warn("Error checking saved game data:", e);
                            this.game.savedGameExists = false;
                        }
                    }
                },

                // --- ユーティリティ ---
                showMessage(text, type = 'success', duration = 3000) {
                    this.message = { text, type };
                    setTimeout(() => { this.message.text = ''; }, duration);
                },
                checkLocalStorage() {
                    try {
                        localStorage.setItem('__test__', 'test');
                        localStorage.removeItem('__test__');
                        this.localStorageAvailable = true;
                    } catch (e) {
                        this.localStorageAvailable = false;
                        console.warn('localStorageへのアクセスがブロックされました。保存機能は無効になります。', e);
                    }
                },
                generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },
                getPlayer(id) {
                    return this.players.find(p => p.id === id);
                },
                getPlayerName(id) {
                    return this.getPlayer(id)?.name || null;
                },
                getPlayerNumber(id) {
                    return this.getPlayer(id)?.number || null;
                },
                getPositionName(id) {
                    if (!id) return null;
                    if (id === 'PH') return '代打';
                    if (id === 'PR') return '代走';
                    return this.positions.find(p => p.id === id)?.name || null;
                },
                getBattingOrder(playerId) {
                    const index = this.lineup.starters.findIndex(s => s.playerId === playerId);
                    return index !== -1 ? index + 1 : null;
                },
                copyToClipboard(text) {
                    if (!text) return;
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed'; 
                    textarea.style.left = '-9999px';
                    textarea.style.opacity = 0;
                    document.body.appendChild(textarea);
                    
                    try {
                        textarea.select();
                        textarea.setSelectionRange(0, textarea.value.length);
                        
                        let successful = false;
                        try {
                            successful = document.execCommand('copy');
                        } catch (err) {
                            console.warn('execCommand copy failed', err);
                            successful = false;
                        }

                        if (successful) {
                            this.showMessage('クリップボードにコピーしました。');
                        } else {
                            this.showMessage('コピーに失敗しました。', 'error');
                        }
                    } catch (e) {
                        console.error('Copy to clipboard failed:', e);
                        this.showMessage('コピーに失敗しました。', 'error');
                    } finally {
                        if (document.body.contains(textarea)) {
                            document.body.removeChild(textarea);
                        }
                    }
                },
                sortPlayers(players) {
                    return players.sort((a, b) => {
                        let numA = Number(a.number);
                        let numB = Number(b.number);
                        
                        numA = (a.number === null || a.number === undefined || a.number === '' || isNaN(numA)) ? Infinity : numA;
                        numB = (b.number === null || b.number === undefined || b.number === '' || isNaN(numB)) ? Infinity : numB;
                        
                        if (numA !== numB) {
                            return numA - numB;
                        }
                        
                        const furiganaA = a.furigana || a.name || '';
                        const furiganaB = b.furigana || b.name || '';
                        const furiganaCompare = furiganaA.localeCompare(furiganaB, 'ja');
                        if (furiganaCompare !== 0) {
                            return furiganaCompare;
                        }

                        const nameA = a.name || '';
                        const nameB = b.name || '';
                        const nameCompare = nameA.localeCompare(nameB, 'ja');
                        if (nameCompare !== 0) {
                            return nameCompare;
                        }
                        
                        return (a.id || '').localeCompare(b.id || '');
                    });
                },

                // --- 選手マスタ (1. Master) ---
                loadPlayers() {
                    let savedPlayers = null;
                    if (this.localStorageAvailable) {
                        try {
                            savedPlayers = localStorage.getItem('baseballApp_players');
                        } catch (e) {
                            console.warn('localStorage.getItem failed (players):', e);
                            savedPlayers = null;
                        }
                    }
                    
                    if (savedPlayers) {
                        try {
                            this.players = this.sortPlayers(JSON.parse(savedPlayers));
                        } catch (e) {
                            console.error('保存された選手データのパースに失敗しました。', e);
                            this.players = this.sortPlayers(this.getDefaultPlayers());
                        }
                    } else {
                        this.players = this.sortPlayers(this.getDefaultPlayers());
                        this.savePlayers(false); // 読み込み失敗時はデフォルトデータを保存試行
                    }
                },
                savePlayers(showMessage = true) {
                    if (!this.localStorageAvailable) {
                        if (showMessage) {
                            this.showMessage('ストレージが利用できず、選手マスタを保存できません。', 'error', 5000);
                        }
                        return; // 保存不可
                    }
                    
                    try {
                        localStorage.setItem('baseballApp_players', JSON.stringify(this.players));
                        if (showMessage) {
                            this.showMessage('選手マスタを保存しました。');
                        }
                    } catch (e) {
                        console.warn('localStorageへの保存に失敗しました (players)。', e);
                        if (showMessage) {
                            this.showMessage('選手マスタの保存に失敗しました。', 'error', 5000);
                        }
                    }
                    
                    this.players = this.sortPlayers(this.players);
                },
                addPlayer() {
                    if (!this.newPlayer.name) {
                        this.showMessage('氏名は必須です。', 'error');
                        return;
                    }
                    this.players.push({
                        id: this.generateUUID(),
                        name: this.newPlayer.name,
                        furigana: this.newPlayer.furigana,
                        number: this.newPlayer.number,
                        grade: this.newPlayer.grade
                    });
                    this.newPlayer = { name: '', furigana: '', number: null, grade: '' };
                    this.savePlayers();
                },
                deletePlayer(id) {
                    this.players = this.players.filter(p => p.id !== id);
                    this.savePlayers();
                },
                exportPlayers() {
                    if (this.players.length === 0) {
                        this.showMessage('エクスポートする選手がいません。', 'error');
                        return;
                    }
                    
                    const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.players, null, 2));
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataStr);
                    linkElement.setAttribute('download', 'antos_players.json');
                    
                    try {
                        document.body.appendChild(linkElement);
                        linkElement.click();
                        this.showMessage('選手データをエクスポートしました。');
                    } catch (e) {
                        console.error('Export failed:', e);
                        this.showMessage('エクスポートに失敗しました。', 'error');
                    } finally {
                        if (document.body.contains(linkElement)) {
                            document.body.removeChild(linkElement);
                        }
                    }
                },
                importPlayers(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedPlayers = JSON.parse(e.target.result);
                            if (Array.isArray(importedPlayers)) {
                                const validPlayers = importedPlayers.filter(p => p.id && p.name).map(p => ({
                                    id: p.id,
                                    name: p.name,
                                    furigana: p.furigana || '',
                                    number: p.number || null,
                                    grade: p.grade || ''
                                }));
                                
                                const playerMap = new Map(this.players.map(p => [p.id, p]));
                                validPlayers.forEach(p => playerMap.set(p.id, p));
                                
                                this.players = Array.from(playerMap.values());
                                this.savePlayers();
                                this.showMessage(`${validPlayers.length}件の選手データをインポートしました。`);
                            } else {
                                throw new Error('無効なファイル形式です。');
                            }
                        } catch (err) {
                            console.error('Import failed:', err);
                            this.showMessage('JSONの読み込みに失敗しました。', 'error');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = null;
                },
                getDefaultPlayers() {
                    return [
                        {id: "1", name: "小高 斗愛", furigana: "オダカ トア", number: 10, grade: "5年"},
                        {id: "2", name: "難波 諒成", furigana: "ナンバ リョウセイ", number: 1, grade: "5年"},
                        {id: "3", name: "高橋 奏多", furigana: "タカハシ カナタ", number: 2, grade: "5年"},
                        {id: "4", name: "浪川 長政", furigana: "ナミカワ ナガマサ", number: 3, grade: "5年"},
                        {id: "5", name: "山田 颯真", furigana: "ヤマダ ソウマ", number: 4, grade: "4年"},
                        {id: "6", name: "津村 一輝", furigana: "ツムラ カヅキ", number: 5, grade: "4年"},
                        {id: "7", name: "菱沼 颯介", furigana: "ヒシヌマ ソウスケ", number: 6, grade: "4年"},
                        {id: "8", name: "小野 暁人", furigana: "オノ アキト", number: 7, grade: "4年"},
                        {id: "9", name: "小高 愛之佑", furigana: "オダカ アイノスケ", number: 8, grade: "3年"},
                        {id: "10", name: "浅野 泰地", furigana: "アサノ タイチ", number: 9, grade: "3年"},
                        {id: "11", name: "近藤 謙成", furigana: "コンドウ ケンセイ", number: 11, grade: "3年"},
                        {id: "12", name: "知野見 怜央", furigana: "チノミ レオ", number: 12, grade: "3年"},
                        {id: "13", name: "藤山 琉杜", furigana: "トウヤマ リュウト", number: 13, grade: "3年"},
                        {id: "14", name: "小河原  維", furigana: "オガワラ タモツ", number: 14, grade: "3年"},
                        {id: "15", name: "古川 峻丞", furigana: "フルカワ シュンスケ", number: 15, grade: "2年"},
                        {id: "16", name: "坪井 雄也", furigana: "ツボイ ユウヤ", number: 16, grade: "1年"},
                        {id: "17", name: "近藤 茉莉", furigana: "コンドウ マツリ", number: 17, grade: "1年"}
                    ];
                },

                // --- 試合設定 (2. Setup) ---
                availablePlayers(currentIndex) {
                    const otherSelectedIds = new Set(
                        this.game.starters
                            .filter((_, index) => index !== currentIndex)
                            .map(s => s.playerId)
                            .filter(id => id !== '')
                    );
                    return this.players.filter(p => !otherSelectedIds.has(p.id));
                },
                availablePositions(currentIndex) {
                    const otherSelectedIds = new Set(
                        this.game.starters
                            .filter((_, index) => index !== currentIndex)
                            .map(s => s.position)
                            .filter(id => id !== '')
                    );
                    return this.positions.filter(p => !otherSelectedIds.has(p.id));
                },
                get benchPlayers() {
                    const starterIds = new Set(this.game.starters.map(s => s.playerId));
                    return this.players.filter(p => !starterIds.has(p.id));
                },
                // *** 新規 *** : 試合設定の保存
                saveGameSettings() {
                    if (!this.localStorageAvailable) {
                        this.showMessage('ストレージが利用できず、試合設定を保存できません。', 'error', 5000);
                        return;
                    }
                    try {
                        localStorage.setItem('baseballApp_gameSettings', JSON.stringify(this.game));
                        this.game.savedGameExists = true;
                        this.showMessage('現在の試合設定を保存しました。');
                    } catch (e) {
                        console.error("Failed to save game settings:", e);
                        this.showMessage('試合設定の保存に失敗しました。', 'error');
                    }
                },
                // *** 新規 *** : 試合設定の読み込み
                loadGameSettings() {
                    if (!this.localStorageAvailable) {
                        this.showMessage('ストレージが利用できません。', 'error', 5000);
                        return;
                    }
                    try {
                        const savedGame = localStorage.getItem('baseballApp_gameSettings');
                        if (savedGame) {
                            const parsedGame = JSON.parse(savedGame);
                            // 互換性のため、主要なプロパティのみを上書き
                            this.game.opponentName = parsedGame.opponentName || '';
                            this.game.myTeamAttack = parsedGame.myTeamAttack || 'first';
                            this.game.myTeamSide = parsedGame.myTeamSide || 'firstBase';
                            this.game.umpires = parsedGame.umpires || { plate: '', first: '', second: '', third: '' };
                            // startersとbenchは、現在の選手マスタIDと一致するもののみ復元
                            this.game.starters = parsedGame.starters.map(s => ({
                                playerId: this.players.find(p => p.id === s.playerId) ? s.playerId : '',
                                position: s.position || ''
                            }));
                            this.game.bench = parsedGame.bench.filter(id => this.players.find(p => p.id === id));
                            
                            this.game.savedGameExists = true;
                            this.showMessage('保存された試合設定を読み込みました。');
                        } else {
                            this.showMessage('保存された試合設定が見つかりません。', 'error');
                        }
                    } catch (e) {
                        console.error("Failed to load game settings:", e);
                        this.showMessage('試合設定の読み込みに失敗しました。', 'error');
                    }
                },
                // *** 新規 *** : 試合設定のクリア
                clearGameSettings() {
                    if (!this.localStorageAvailable) {
                        this.showMessage('ストレージが利用できません。', 'error', 5000);
                        return;
                    }
                    try {
                        localStorage.removeItem('baseballApp_gameSettings');
                        this.game.savedGameExists = false;
                        this.showMessage('保存された試合設定をクリアしました。');
                    } catch (e) {
                        console.error("Failed to clear game settings:", e);
                        this.showMessage('試合設定のクリアに失敗しました。', 'error');
                    }
                },
                confirmLineup() {
                    if (!this.game.opponentName) {
                        this.showMessage('対戦相手を入力してください。', 'error');
                        this.activeTab = 'setup';
                        return;
                    }
                    const startersComplete = this.game.starters.every(s => s.playerId && s.position);
                    if (this.game.starters.length !== 9 || !startersComplete) {
                        this.showMessage('スターティングメンバー9人全員の選手と守備位置を設定してください。', 'error');
                        this.activeTab = 'setup';
                        return;
                    }
                    
                    this.lineup.starters = JSON.parse(JSON.stringify(this.game.starters));
                    this.lineup.bench = JSON.parse(JSON.stringify(this.game.bench));
                    
                    this.game.started = true;
                    this.activeTab = 'sheet';
                    this.sheetSubTab = 'progress';
                    this.announcement = '';
                    
                    this.progress = {
                        inning: 1,
                        topOrBottom: 'top',
                        myTeamScore: 0,
                        opponentScore: 0,
                        battingOrderIndex: { first: 0, second: 0 }
                    };
                },

                // --- アナウンスシート (3. Sheet) ---
                nextInningState() {
                    if (this.progress.topOrBottom === 'top') {
                        this.progress.topOrBottom = 'bottom';
                    } else {
                        this.progress.topOrBottom = 'top';
                        this.progress.inning++;
                    }
                },
                prevInningState() {
                    if (this.progress.topOrBottom === 'bottom') {
                        this.progress.topOrBottom = 'top';
                    } else if (this.progress.inning > 1) {
                        this.progress.topOrBottom = 'bottom';
                        this.progress.inning--;
                    }
                },
                
                generatePreGameLineupCall() {
                    const side = this.game.myTeamSide === 'firstBase' ? '一塁側' : '三塁側';
                    const opponentSide = this.game.myTeamSide === 'firstBase' ? '三塁側' : '一塁側';
                    
                    this.announcement = `本日の第 ( ) 試合、(${side}) ありんこアントス と (${opponentSide}) ${this.game.opponentName || '(対戦相手)'} の試合です。\n\n「メンバー表を持って、ネット裏本部までお越しください。」\n\n「この監督・キャプテンはシートノックの準備をしてください。」`;
                },
                generateKnockCall(team) { 
                    const teamName = (team === this.game.myTeamAttack) ? 'ありんこアントス' : (this.game.opponentName || '(対戦相手)');
                    const type = (team === 'first') ? '(先攻)' : '(後攻)';
                    
                    this.announcement = `(${type}) ${teamName} \n\n「シートノックを開始してください。時間は5分です。」\n...\n「シートノック、残り1分です。」\n「シートノック時間です。」`;
                },
                generateStartingMemberCall(team) {
                    if (!this.game.started) {
                        this.showMessage('先に「試合設定」タブで「試合開始」ボタンを押してください。', 'error');
                        this.activeTab = 'setup';
                        return;
                    }
                    if (team === 'ants') {
                        const teamType = (this.game.myTeamAttack === 'first') ? '先攻' : '後攻';
                        let text = `お待たせいたしました。\nただいまより本日の第 ( ) 試合、\n${teamType} (ありんこアントス) のスターティングメンバー並びに控え選手をご紹介致します。\n\n`;
                        
                        this.lineup.starters.forEach((starter, i) => {
                            const player = this.getPlayer(starter.playerId);
                            const pos = this.getPositionName(starter.position);
                            text += `${i + 1}番、(${pos || ' '})、(${player?.name || ' '})くん、背番号 (${player?.number || ' '})。\n`;
                        });
                        
                        text += "\n控え選手は、\n";
                        if (this.lineup.bench.length > 0) {
                            this.lineup.bench.forEach(playerId => {
                                const player = this.getPlayer(playerId);
                                text += `(${player?.name || ' '})くん、背番号 (${player?.number || ' '})。\n`;
                            });
                        } else {
                            text += "控え選手はおりません。\n";
                        }
                        this.announcement = text;
                        
                    } else { 
                        const teamType = (this.game.myTeamAttack === 'first') ? '後攻' : '先攻';
                        this.announcement = `続きまして、${teamType} (${this.game.opponentName || '(対戦相手)'}) のスターティングメンバーをご紹介致します。\n\n`;
                        this.announcement += `(※相手チームのメンバー表に従ってアナウンスしてください)\n\n例:\n1番、(守備位置)、(氏名)くん、背番号 ( )。\n...`;
                    }
                },
                // *** 修正 *** : 審判名のプレースホルダーを追加
                generateUmpireCall() {
                    this.announcement = `この試合の審判をご紹介致します。\n\n`;
                    this.announcement += `球審: (${this.game.umpires.plate || '(球審氏名)'})\n`;
                    this.announcement += `一塁: (${this.game.umpires.first || '(一塁氏名)'})\n`;
                    this.announcement += `二塁: (${this.game.umpires.second || '(二塁氏名)'})\n`;
                    this.announcement += `三塁: (${this.game.umpires.third || '(三塁氏名)'})\n\n`;
                    this.announcement += `以上の4氏でございます。\n\n`;
                    this.announcement += `本日の放送担当は ( ) が担当します。`;
                },
                generateFieldCall() {
                    const isAntsDefense = (this.progress.topOrBottom === 'top' && this.game.myTeamAttack === 'second') || 
                                          (this.progress.topOrBottom === 'bottom' && this.game.myTeamAttack === 'first');
                    
                    if (!isAntsDefense) {
                        this.announcement = `${this.progress.inning}回 ${this.progress.topOrBottom === 'top' ? '表' : '裏'}、${this.game.opponentName || '(対戦相手)'} の守備を紹介します。\n\n(※相手チームの守備位置をアナウンスしてください)`;
                        return;
                    }
                    
                    let text = `${this.progress.inning}回 ${this.progress.topOrBottom === 'top' ? '表' : '裏'}、ありんこアントス、守備につきます。\n守備位置の紹介をいたします。\n\n`;
                    
                    const positionsOrder = ['1', '2', '3', '4', '5', '6', '7', '8', '9'];
                    const playersByPos = {};
                    this.lineup.starters.forEach(s => {
                        // PH/PRの選手は守備についていない
                        if (s.position !== 'PH' && s.position !== 'PR') {
                            playersByPos[s.position] = this.getPlayer(s.playerId);
                        }
                    });
                    
                    positionsOrder.forEach(posId => {
                        const posName = this.getPositionName(posId);
                        const player = playersByPos[posId];
                        text += `${posName}、(${player?.name || ' '})くん。\n`;
                    });
                    
                    this.announcement = text;
                },
                generateInningAttackCall() {
                    const inningText = `${this.progress.inning}回 ${this.progress.topOrBottom === 'top' ? '表' : '裏'}`;
                    
                    const isAntsAttack = (this.progress.topOrBottom === 'top' && this.game.myTeamAttack === 'first') || 
                                         (this.progress.topOrBottom === 'bottom' && this.game.myTeamAttack === 'second');
                    
                    if (!isAntsAttack) {
                        this.announcement = `${inningText}、${this.game.opponentName || '(対戦相手)'} の攻撃は、\n\n(※相手チームの打順をアナウンスしてください)`;
                        return;
                    }
                    
                    let text = `${inningText}、ありんこアントス の攻撃は、\n\n`;
                    
                    const attackKey = (this.game.myTeamAttack === 'first') ? 'first' : 'second';
                    let currentIndex = this.progress.battingOrderIndex[attackKey];
                    
                    const starter = this.lineup.starters[currentIndex];
                    const player = this.getPlayer(starter.playerId);
                    const posName = this.getPositionName(starter.position);
                    const order = currentIndex + 1;
                    
                    text += `${order}番、(${posName || ' '})、(${player?.name || ' '})くん、背番号 (${player?.number || ' '})。\n`;
                    text += `${order}番、(${posName || ' '})、(${player?.name || ' '})くん。`;
                    
                    this.progress.battingOrderIndex[attackKey] = (currentIndex + 1) % 9;
                    
                    this.announcement = text;
                },
                generateInningScoreCall() {
                    const inningText = `${this.progress.inning}回 ${this.progress.topOrBottom === 'top' ? '表' : '裏'}`;
                    this.announcement = `${inningText} の得点は ( ) 点です。`;
                },
                generateGameEndCall() {
                    let winner, loser, winnerScore, loserScore;
                    
                    if (this.progress.myTeamScore > this.progress.opponentScore) {
                        winner = 'ありんこアントス';
                        winnerScore = this.progress.myTeamScore;
                        loser = this.game.opponentName || '(対戦相手)';
                        loserScore = this.progress.opponentScore;
                    } else if (this.progress.opponentScore > this.progress.myTeamScore) {
                        winner = this.game.opponentName || '(対戦相手)';
                        winnerScore = this.progress.opponentScore;
                        loser = 'ありんこアントス';
                        loserScore = this.progress.myTeamScore;
                    } else {
                        this.announcement = `本日の第 ( ) 試合、ありんこアントス 対 ${this.game.opponentName || '(対戦相手)'} は、\n${this.progress.myTeamScore} 対 ${this.progress.opponentScore}、引き分けとなりました。`;
                        return;
                    }
                    
                    this.announcement = `本日の第 ( ) 試合、\n${winner} 対 ${loser} は、\n${winnerScore} 対 ${loserScore} をもちまして、\n${winner} の勝ちとなりました。\n\n「両チームの監督・コーチはベンチの移動とグランド整備にご協力ください。」`;
                },
                
                // -- 3b. 選手交代 --
                generatePositionChange() {
                    const input = this.changeForms.positionChange.replace(/[^1-9\-]/g, '');
                    if (!input) {
                        this.showMessage('守備位置番号をハイフン(-)でつないで入力してください。例: 4-1', 'error');
                        return;
                    }
                    const posIds = input.split('-').filter(Boolean);
                    if (posIds.length < 2) {
                        this.showMessage('最低2つの守備位置を入力してください。', 'error');
                        return;
                    }

                    let text = "ありんこアントス、守備位置の交代をお知らせします。\n\n";
                    let changes = [];
                    
                    for (let i = 0; i < posIds.length; i++) {
                        const currentPosId = posIds[i];
                        const nextPosId = posIds[(i + 1) % posIds.length];

                        const currentPlayer = this.lineup.starters.find(s => s.position === currentPosId);
                        if (!currentPlayer) {
                            this.showMessage(`エラー: ${this.getPositionName(currentPosId)} に選手がいません。`, 'error');
                            return;
                        }
                        
                        const playerName = this.getPlayerName(currentPlayer.playerId);
                        const nextPosName = this.getPositionName(nextPosId);
                        
                        text += `(${this.getPositionName(currentPosId)})、(${playerName})くんが、(${nextPosName})に入り、\n`;
                        
                        changes.push({
                            posName: nextPosName,
                            playerName: playerName,
                            playerId: currentPlayer.playerId
                        });
                    }
                    text = text.slice(0, -2) + "ます。\n\n";

                    if (changes.length >= 2) {
                        const last = changes[changes.length - 1];
                        const secondLast = changes[changes.length - 2];
                        
                        const order1 = this.getBattingOrder(secondLast.playerId);
                        const order2 = this.getBattingOrder(last.playerId);

                        text += `(${order1 || ' '})番、(${secondLast.posName || ' '})、(${secondLast.playerName || ' '})くん。\n`;
                        text += `(${order2 || ' '})番、(${last.posName || ' '})、(${last.playerName || ' '})くん。\n`;
                    } else if (changes.length === 1) { 
                         const change = changes[0];
                         const order = this.getBattingOrder(change.playerId);
                         text += `(${order || ' '})番、(${change.posName || ' '})、(${change.playerName || ' '})くん。\n`;
                    }
                    
                    const newStarters = JSON.parse(JSON.stringify(this.lineup.starters));
                    for (let i = 0; i < posIds.length; i++) {
                        const currentPosId = posIds[i];
                        const nextPosId = posIds[(i + 1) % posIds.length];
                        
                        const starterIndex = newStarters.findIndex(s => s.position === currentPosId);
                        if (starterIndex !== -1) {
                            newStarters[starterIndex].position = nextPosId;
                        }
                    }
                    this.lineup.starters = newStarters;
                    
                    this.announcement = text;
                    this.changeForms.positionChange = '';
                    this.showMessage('守備交代アナウンスを生成しました。ラインナップも更新されました。');
                },
                generatePlayerChange() {
                    const { outPlayerId, inPlayerId, newPosition } = this.changeForms.playerChange;
                    if (!outPlayerId || !inPlayerId || !newPosition) {
                        this.showMessage('全ての項目を選択してください。', 'error');
                        return;
                    }
                    
                    const outPlayer = this.getPlayer(outPlayerId);
                    const inPlayer = this.getPlayer(inPlayerId);
                    const outStarter = this.lineup.starters.find(s => s.playerId === outPlayerId);
                    
                    if (!outPlayer || !inPlayer || !outStarter) {
                        this.showMessage('選手情報が正しく取得できませんでした。', 'error');
                        return;
                    }
                    
                    const outPositionName = this.getPositionName(outStarter.position);
                    const newPositionName = this.getPositionName(newPosition);
                    const battingOrder = this.getBattingOrder(outPlayerId);
                    
                    let text = "ありんこアントス、選手の交代をお知らせします。\n\n";
                    text += `(${outPositionName || ' '})、(${outPlayer.name})くんに代わりまして、(${inPlayer.name})くんが、(${newPositionName})に入ります。\n\n`;
                    text += `(${battingOrder})番、(${newPositionName})、(${inPlayer.name})くん。背番号 (${inPlayer.number || ' '})。`;
                    
                    this.lineup.starters = this.lineup.starters.map(s => {
                        if (s.playerId === outPlayerId) {
                            return { playerId: inPlayerId, position: newPosition };
                        }
                        return s;
                    });
                    this.lineup.bench = this.lineup.bench.filter(id => id !== inPlayerId);
                    this.lineup.bench.push(outPlayerId);
                    
                    this.announcement = text;
                    this.changeForms.playerChange = { outPlayerId: '', inPlayerId: '', newPosition: '' };
                    this.showMessage('選手交代アナウンスを生成しました。ラインナップも更新されました。');
                },
                generatePinchHitter() {
                    const { outPlayerId, inPlayerId } = this.changeForms.pinchHitter;
                    if (!outPlayerId || !inPlayerId) {
                        this.showMessage('両方の選手を選択してください。', 'error');
                        return;
                    }
                    
                    const outPlayer = this.getPlayer(outPlayerId);
                    const inPlayer = this.getPlayer(inPlayerId);
                    const battingOrder = this.getBattingOrder(outPlayerId);

                    if (!outPlayer || !inPlayer || !battingOrder) {
                        this.showMessage('選手情報が正しく取得できませんでした。', 'error');
                        return;
                    }
                    
                    let text = "ありんこアントス、選手の交代をお知らせします。\n\n";
                    text += `【代打】 (${battingOrder})番、(${outPlayer.name})くんに代わりまして、代打 (${inPlayer.name})くん、背番号 (${inPlayer.number || ' '})。`;
                    
                    this.lineup.starters = this.lineup.starters.map(s => {
                        if (s.playerId === outPlayerId) {
                            return { playerId: inPlayerId, position: 'PH' }; // 'PH' = 代打
                        }
                        return s;
                    });
                    this.lineup.bench = this.lineup.bench.filter(id => id !== inPlayerId);
                    this.lineup.bench.push(outPlayerId);
                    
                    this.announcement = text;
                    this.changeForms.pinchHitter = { outPlayerId: '', inPlayerId: '' };
                    this.showMessage('代打アナウンスを生成しました。ラインナップも更新されました。');
                },
                generatePinchRunner() {
                    const { outPlayerId, inPlayerId, base } = this.changeForms.pinchRunner;
                    if (!outPlayerId || !inPlayerId) {
                        this.showMessage('両方の選手を選択してください。', 'error');
                        return;
                    }
                    
                    const outPlayer = this.getPlayer(outPlayerId);
                    const inPlayer = this.getPlayer(inPlayerId);
                    
                    if (!outPlayer || !inPlayer) {
                        this.showMessage('選手情報が正しく取得できませんでした。', 'error');
                        return;
                    }
                    
                    let text = "ありんこアントス、選手の交代をお知らせします。\n\n";
                    text += `【代走】 (${base})塁走者、(${outPlayer.name})くんに代わりまして、代走 (${inPlayer.name})くん、背番号 (${inPlayer.number || ' '})。`;
                    
                    const starterIndex = this.lineup.starters.findIndex(s => s.playerId === outPlayerId);
                    if (starterIndex !== -1) {
                        this.lineup.starters[starterIndex].playerId = inPlayerId;
                        this.lineup.starters[starterIndex].position = 'PR'; // 'PR' = 代走
                        
                        this.lineaup.bench = this.lineup.bench.filter(id => id !== inPlayerId);
                        this.lineup.bench.push(outPlayerId);
                    } else {
                        // 控え同士の交代など
                        this.lineup.bench = this.lineup.bench.filter(id => id !== inPlayerId);
                        if (!this.lineup.bench.includes(outPlayerId)) {
                             this.lineup.bench.push(outPlayerId);
                        }
                    }
                    
                    this.announcement = text;
                    this.changeForms.pinchRunner = { outPlayerId: '', inPlayerId: '', base: '一' };
                    this.showMessage('代走アナウンスを生成しました。ラインナップも更新されました。');
                },
                
            }))
        })
    </script>

</body>
</html>