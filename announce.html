<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野球アナウンス サポートツール</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントを読み込み -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 守備位置の番号（入力フィールド用） */
        .position-input {
            width: 40px;
            height: 40px;
            text-align: center;
            border-radius: 50%;
            border: 2px solid #ddd;
            font-weight: bold;
            color: #333;
        }
        .position-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        /* アクティブな打順をハイライト */
        .active-batter {
            background-color: #eff6ff; /* blue-50 */
            border-left: 4px solid #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">野球アナウンス サポートツール</h1>
        </header>

        <!-- データ操作エリア -->
        <div class="mb-6 p-4 bg-white rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-3">データ操作</h2>
            <div class="flex flex-wrap gap-3">
                <button id="saveData" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
                    現在の状態を保存
                </button>
                <button id="loadData" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
                    保存した状態を読み込む
                </button>
                <button id="resetData" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out">
                    データをリセット
                </button>
            </div>
            <p id="storageStatus" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 左カラム: 設定とメンバー登録 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 1. 試合情報 -->
                <section id="setup" class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">1. 試合情報</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="gameTitle" class="block text-sm font-medium text-gray-700 mb-1">大会名</label>
                            <input type="text" id="gameTitle" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="gameVenue" class="block text-sm font-medium text-gray-700 mb-1">試合会場</label>
                            <input type="text" id="gameVenue" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="opponentTeam" class="block text-sm font-medium text-gray-700 mb-1">相手チーム名</label>
                            <input type="text" id="opponentTeam" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <span class="block text-sm font-medium text-gray-700 mb-1">先攻 / 後攻</span>
                            <div class="flex gap-4">
                                <label class="flex items-center">
                                    <input type="radio" name="playOrder" value="first" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                    <span class="ml-2">自チームが先攻</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="playOrder" value="second" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                                    <span class="ml-2">自チームが後攻</span>
                                </label>
                            </div>
                        </div>
                        <!-- 審判入力 -->
                        <div class="md:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label for="umpirePL" class="block text-sm font-medium text-gray-700 mb-1">球審</label>
                                <input type="text" id="umpirePL" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="umpire1B" class="block text-sm font-medium text-gray-700 mb-1">一塁</label>
                                <input type="text" id="umpire1B" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="umpire2B" class="block text-sm font-medium text-gray-700 mb-1">二塁</label>
                                <input type="text" id="umpire2B" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="umpire3B" class="block text-sm font-medium text-gray-700 mb-1">三塁</label>
                                <input type="text" id="umpire3B" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. メンバー登録 -->
                <section id="roster" class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">2. メンバー登録 (自チーム)</h2>
                    
                    <!-- スタメン -->
                    <h3 class="text-lg font-semibold mb-3">スターティングメンバー</h3>
                    <div id="startingMembers" class="space-y-3">
                        <!-- JSで動的に9人分生成 -->
                    </div>

                    <!-- ベンチ -->
                    <h3 class="text-lg font-semibold mt-6 mb-3">ベンチメンバー</h3>
                    <div id="benchMembers" class="space-y-3">
                        <!-- JSで動的に生成 -->
                    </div>
                    <button id="addBenchPlayer" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        + ベンチメンバーを追加
                    </button>
                </section>

                <!-- 3. 選手交代 -->
                <section id="substitution" class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">3. 選手交代</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- GUI交代 -->
                        <div>
                            <h3 class="text-lg font-semibold mb-3">かんたん交代 (代打・代走・守備)</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="subOutPlayer" class="block text-sm font-medium text-gray-700 mb-1">交代する選手 (OUT)</label>
                                    <select id="subOutPlayer" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <!-- JSでスタメン・ベンチ選手を読み込む -->
                                    </select>
                                </div>
                                <div>
                                    <label for="subInPlayer" class="block text-sm font-medium text-gray-700 mb-1">出場する選手 (IN)</label>
                                    <select id="subInPlayer" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <!-- JSでベンチ選手を読み込む -->
                                    </select>
                                </div>
                                <div>
                                    <label for="subPosition" class="block text-sm font-medium text-gray-700 mb-1">守備位置 (交代後)</label>
                                    <select id="subPosition" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="">守備位置を選択</option>
                                        <option value="1">1: ピッチャー</option>
                                        <option value="2">2: キャッチャー</option>
                                        <option value="3">3: ファースト</option>
                                        <option value="4">4: セカンド</option>
                                        <option value="5">5: サード</option>
                                        <option value="6">6: ショート</option>
                                        <option value="7">7: レフト</option>
                                        <option value="8">8: センター</option>
                                        <option value="9">9: ライト</option>
                                        <option value="DH">DH</option>
                                        <option value="PH">代打 (PH)</option>
                                        <option value="PR">代走 (PR)</option>
                                        <option value="BENCH">ベンチへ</option>
                                    </select>
                                </div>
                                <button id="executeSubstitution" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                                    交代を実行
                                </button>
                            </div>
                        </div>
                        <!-- 守備位置一括変更 -->
                        <div>
                            <h3 class="text-lg font-semibold mb-3">守備位置 一括変更 (玉突き)</h3>
                            <p class="text-sm text-gray-600 mb-2">例: 「4-6, 6-4」 (セカンドとショート入替)<br>例: 「4-3-1」 (セカンド→ファースト、ファースト→ピッチャー、ピッチャー→？)</p>
                            <input type="text" id="multiSubInput" placeholder="例: 4-6, 6-4" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 mb-3">
                            <button id="executeMultiSub" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">
                                一括変更を実行
                            </button>
                            <div id="multiSubMessage" class="text-sm text-red-600 mt-2"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 右カラム: 試合進行とアナウンス -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 4. 試合進行 -->
                <section id="game" class="bg-white rounded-lg shadow p-6 sticky top-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">4. 試合進行</h2>
                    
                    <!-- イニング・アウトカウント -->
                    <div class="text-center mb-4">
                        <h3 id="inningDisplay" class="text-3xl font-bold text-blue-600">1回 表</h3>
                        <p id="outDisplay" class="text-xl font-semibold text-gray-700">0 アウト</p>
                    </div>

                    <!-- 打順 -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">現在の打順</h4>
                        <p id="currentBatterDisplay" class="text-lg font-medium text-gray-800 p-3 bg-gray-100 rounded-lg text-center">
                            （試合開始前）
                        </p>
                    </div>

                    <!-- 進行ボタン -->
                    <div class="grid grid-cols-2 gap-4">
                        <button id="nextBatter" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow text-lg">
                            次の打者
                        </button>
                        <button id="addOut" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow text-lg">
                            アウト
                        </button>
                        <button id="changeSides" class="col-span-2 bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-4 rounded-lg shadow text-lg">
                            3アウト (チェンジ)
                        </button>
                    </div>
                </section>

                <!-- 5. アナウンス -->
                <section id="announce" class="bg-white rounded-lg shadow p-6 sticky top-96">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">5. アナウンス内容</h2>
                    
                    <!-- アナウンス種類ボタン -->
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button class="announce-btn bg-green-100 hover:bg-green-200 text-green-800 py-2 px-3 rounded-lg" data-type="preGame">試合開始前</button>
                        <button class="announce-btn bg-green-100 hover:bg-green-200 text-green-800 py-2 px-3 rounded-lg" data-type="startMember">スタメン発表</button>
                        <button class="announce-btn bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded-lg" data-type="inningStart">イニング開始</button>
                        <button class="announce-btn bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-3 rounded-lg" data-type="batterUp">打者紹介</button>
                        <button class="announce-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-2 px-3 rounded-lg" data-type="substitution">選手交代</button>
                        <button class="announce-btn bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-2 px-3 rounded-lg" data-type="umpireIntro">審判紹介</button>
                    </div>

                    <!-- アナウンス表示エリア -->
                    <div id="announceOutput" class="w-full h-64 bg-gray-800 text-white p-4 rounded-lg overflow-y-auto font-mono whitespace-pre-wrap">
                        ここにアナウンス内容が表示されます。
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- カスタム確認モーダル -->
    <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none; z-index: 999;">
      <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="confirmTitle">確認</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500" id="confirmMessage">実行しますか？</p>
          </div>
          <div class="items-center px-4 py-3 gap-3 flex justify-center">
            <button id="confirmOk" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-24 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
              はい
            </button>
            <button id="confirmCancel" class="px-4 py-2 bg-gray-300 text-gray-900 text-base font-medium rounded-md w-24 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
              キャンセル
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
        // 守備位置の定義
        const POSITIONS = {
            1: "ピッチャー", 2: "キャッチャー", 3: "ファースト",
            4: "セカンド", 5: "サード", 6: "ショート",
            7: "レフト", 8: "センター", 9: "ライト",
            "DH": "指名打者", "PH": "代打", "PR": "代走", "BENCH": "ベンチ"
        };

        // --- 状態管理 ---
        let gameState = {};

        // デフォルトの状態
        function getDefaultState() {
            return {
                gameInfo: {
                    title: "",
                    venue: "",
                    opponent: "",
                    playOrder: "second", // 'first' or 'second'
                    umpires: { pl: "", "1b": "", "2b": "", "3b": "" }
                },
                roster: {
                    starting: Array(9).fill(null).map((_, i) => ({ id: `s${i}`, order: i + 1, name: "", number: "", position: "" })),
                    bench: [{ id: `b0`, name: "", number: "" }]
                },
                gameProgress: {
                    inning: 1,
                    topOrBottom: "top", // 'top' or 'bottom'
                    outs: 0,
                    currentBatterIndex: 0 // roster.starting のインデックス
                },
                substitutionHistory: [] // 交代履歴
            };
        }

        // --- ユーティリティ関数 ---
        
        // カスタム確認ダイアログ
        function customConfirm(message, title = "確認") {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                modal.style.display = 'flex';

                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');

                const close = (value) => {
                    modal.style.display = 'none';
                    // イベントリスナーをクローンして置き換えることで、古いリスナーを削除
                    okBtn.replaceWith(okBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    resolve(value);
                };

                okBtn.addEventListener('click', () => close(true), { once: true });
                cancelBtn.addEventListener('click', () => close(false), { once: true });
            });
        }

        // 状態をUIに反映
        function renderUI() {
            // 1. 試合情報
            const info = gameState.gameInfo;
            document.getElementById('gameTitle').value = info.title || "";
            document.getElementById('gameVenue').value = info.venue || "";
            document.getElementById('opponentTeam').value = info.opponent || "";
            document.querySelector(`input[name="playOrder"][value="${info.playOrder}"]`).checked = true;
            document.getElementById('umpirePL').value = info.umpires.pl || "";
            document.getElementById('umpire1B').value = info.umpires["1b"] || "";
            document.getElementById('umpire2B').value = info.umpires["2b"] || "";
            document.getElementById('umpire3B').value = info.umpires["3b"] || "";

            // 2. メンバー登録
            renderStartingMembers();
            renderBenchMembers();

            // 3. 試合進行
            renderGameProgress();

            // 4. 交代用ドロップダウン
            updateSubstitutionDropdowns();
        }

        // スタメンUI描画
        function renderStartingMembers() {
            const container = document.getElementById('startingMembers');
            container.innerHTML = '';
            const positionLabels = ["", "P", "C", "1B", "2B", "3B", "SS", "LF", "CF", "RF", "DH"];

            gameState.roster.starting.forEach((player, i) => {
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-3 rounded-lg ${i === gameState.gameProgress.currentBatterIndex ? 'active-batter' : 'bg-gray-50'}`;
                div.dataset.playerId = player.id;
                
                div.innerHTML = `
                    <span class="font-bold text-lg text-gray-700 w-6">${player.order}</span>
                    <input type="text" data-field="name" value="${player.name}" placeholder="氏名" class="flex-grow border-gray-300 rounded-lg shadow-sm text-sm p-2">
                    <input type="text" data-field="number" value="${player.number}" placeholder="背番号" class="w-20 border-gray-300 rounded-lg shadow-sm text-sm p-2">
                    <select data-field="position" class="w-36 border-gray-300 rounded-lg shadow-sm text-sm p-2">
                        <option value="">守備位置</option>
                        ${Object.entries(POSITIONS).filter(([key]) => key !== 'PH' && key !== 'PR' && key !== 'BENCH').map(([key, name]) => 
                            `<option value="${key}" ${player.position == key ? 'selected' : ''}>${key}: ${name}</option>`
                        ).join('')}
                    </select>
                `;
                container.appendChild(div);
            });
        }

        // ベンチUI描画
        function renderBenchMembers() {
            const container = document.getElementById('benchMembers');
            container.innerHTML = '';
            gameState.roster.bench.forEach(player => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.dataset.playerId = player.id;
                div.innerHTML = `
                    <input type="text" data-field="name" value="${player.name}" placeholder="氏名" class="flex-grow border-gray-300 rounded-lg shadow-sm text-sm p-2">
                    <input type="text" data-field="number" value="${player.number}" placeholder="背番号" class="w-20 border-gray-300 rounded-lg shadow-sm text-sm p-2">
                    <button class="removeBenchPlayer text-red-500 hover:text-red-700 font-bold text-xl px-2" data-id="${player.id}">&times;</button>
                `;
                container.appendChild(div);
            });
        }

        // 試合進行UI描画
        function renderGameProgress() {
            const progress = gameState.gameProgress;
            document.getElementById('inningDisplay').textContent = `${progress.inning}回 ${progress.topOrBottom === 'top' ? '表' : '裏'}`;
            document.getElementById('outDisplay').textContent = `${progress.outs} アウト`;
            updateCurrentBatterDisplay();
        }

        // 現在の打者表示を更新
        function updateCurrentBatterDisplay() {
            const progress = gameState.gameProgress;
            const batter = gameState.roster.starting[progress.currentBatterIndex];
            const display = document.getElementById('currentBatterDisplay');
            
            // ハイライト更新
            document.querySelectorAll('#startingMembers > div').forEach((div, i) => {
                div.classList.toggle('active-batter', i === progress.currentBatterIndex);
                div.classList.toggle('bg-gray-50', i !== progress.currentBatterIndex);
            });

            if (!batter || !batter.name) {
                display.textContent = "（選手情報がありません）";
                return;
            }

            // 攻撃側か守備側か
            const isOurAttack = (gameState.gameInfo.playOrder === 'first' && progress.topOrBottom === 'top') || 
                                (gameState.gameInfo.playOrder === 'second' && progress.topOrBottom === 'bottom');

            if (isOurAttack) {
                const pos = POSITIONS[batter.position] || '（守備位置未定）';
                display.textContent = `${batter.order}番 ${batter.name} (${pos})`;
            } else {
                display.textContent = `${gameState.gameInfo.opponent}の攻撃 (${batter.order}番～)`;
            }
        }

        // 交代用ドロップダウン更新
        function updateSubstitutionDropdowns() {
            const subOut = document.getElementById('subOutPlayer');
            const subIn = document.getElementById('subInPlayer');
            
            subOut.innerHTML = '<option value="">交代する選手を選択</option>';
            subIn.innerHTML = '<option value="">出場する選手を選択</option>';

            // 交代OUT対象 (スタメン + ベンチで出場中の選手...は複雑なので、一旦スタメン全員)
            gameState.roster.starting.forEach(p => {
                if(p.name) subOut.innerHTML += `<option value="${p.id}">${p.order}番 ${p.name} (${POSITIONS[p.position] || '？'})</option>`;
            });
            // 交代IN対象 (ベンチ)
            gameState.roster.bench.forEach(p => {
                if(p.name) subIn.innerHTML += `<option value="${p.id}">${p.name} (背番号 ${p.number || '？'})</option>`;
            });
        }


        // --- UIイベントリスナー ---

        // 1. 試合情報入力
        document.getElementById('setup').addEventListener('input', (e) => {
            const target = e.target;
            const id = target.id;
            const value = target.value;

            if (id === 'gameTitle') gameState.gameInfo.title = value;
            else if (id === 'gameVenue') gameState.gameInfo.venue = value;
            else if (id === 'opponentTeam') gameState.gameInfo.opponent = value;
            else if (id === 'umpirePL') gameState.gameInfo.umpires.pl = value;
            else if (id === 'umpire1B') gameState.gameInfo.umpires["1b"] = value;
            else if (id === 'umpire2B') gameState.gameInfo.umpires["2b"] = value;
            else if (id === 'umpire3B') gameState.gameInfo.umpires["3b"] = value;
            else if (target.name === 'playOrder') gameState.gameInfo.playOrder = value;
        });

        // 2. メンバー登録入力
        // スタメン
        document.getElementById('startingMembers').addEventListener('input', (e) => {
            const input = e.target;
            const field = input.dataset.field;
            const playerId = input.closest('div').dataset.playerId;
            const player = gameState.roster.starting.find(p => p.id === playerId);
            if (player) {
                player[field] = input.value;
            }
            // 打順が更新されたら打者表示も更新
            if(field === 'name' || field === 'position') {
                updateCurrentBatterDisplay();
            }
        });
        // ベンチ
        document.getElementById('benchMembers').addEventListener('input', (e) => {
            const input = e.target;
            const field = input.dataset.field;
            const playerId = input.closest('div').dataset.playerId;
            const player = gameState.roster.bench.find(p => p.id === playerId);
            if (player) {
                player[field] = input.value;
            }
        });
        // ベンチメンバー追加
        document.getElementById('addBenchPlayer').addEventListener('click', () => {
            const newId = `b${new Date().getTime()}`;
            gameState.roster.bench.push({ id: newId, name: "", number: "" });
            renderBenchMembers();
            updateSubstitutionDropdowns();
        });
        // ベンチメンバー削除
        document.getElementById('benchMembers').addEventListener('click', (e) => {
            if (e.target.classList.contains('removeBenchPlayer')) {
                const idToRemove = e.target.dataset.id;
                gameState.roster.bench = gameState.roster.bench.filter(p => p.id !== idToRemove);
                renderBenchMembers();
                updateSubstitutionDropdowns();
            }
        });

        // 3. 試合進行ボタン
        // 次の打者
        document.getElementById('nextBatter').addEventListener('click', () => {
            const progress = gameState.gameProgress;
            progress.currentBatterIndex = (progress.currentBatterIndex + 1) % 9;
            renderGameProgress();
        });
        // アウト
        document.getElementById('addOut').addEventListener('click', () => {
            const progress = gameState.gameProgress;
            if (progress.outs < 2) {
                progress.outs++;
            } else {
                // 3アウトになったら自動でチェンジ
                changeSides();
            }
            renderGameProgress();
        });
        // 3アウトチェンジ
        document.getElementById('changeSides').addEventListener('click', changeSides);

        function changeSides() {
            const progress = gameState.gameProgress;
            progress.outs = 0;
            if (progress.topOrBottom === 'top') {
                progress.topOrBottom = 'bottom';
            } else {
                progress.topOrBottom = 'top';
                progress.inning++;
            }
            // 打順を1番に戻す (イニングの先頭打者)
            progress.currentBatterIndex = 0; // TODO: 前回の続きから？ 仕様確認。ひとまず1番から。
            renderGameProgress();
            // アナウンスエリアを自動更新
            generateAnnouncement("inningStart");
        }

        // 4. アナウンス生成ボタン
        document.getElementById('announce').addEventListener('click', (e) => {
            if (e.target.classList.contains('announce-btn')) {
                const type = e.target.dataset.type;
                generateAnnouncement(type);
            }
        });

        // 5. 選手交代
        document.getElementById('executeSubstitution').addEventListener('click', handleSimpleSubstitution);
        document.getElementById('executeMultiSub').addEventListener('click', handleMultiSubstitution);


        // --- データ保存/読込 ---
        const STORAGE_KEY = 'baseballAnnounceToolState';
        const statusEl = document.getElementById('storageStatus');

        document.getElementById('saveData').addEventListener('click', async () => {
            if (await customConfirm("現在の状態をブラウザに保存します。よろしいですか？")) {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
                    statusEl.textContent = `保存しました。 (${new Date().toLocaleTimeString()})`;
                    statusEl.className = 'text-sm text-green-600 mt-2';
                } catch (e) {
                    console.error("保存に失敗しました: ", e);
                    statusEl.textContent = "保存に失敗しました。容量オーバーの可能性があります。";
                    statusEl.className = 'text-sm text-red-600 mt-2';
                }
            }
        });

        document.getElementById('loadData').addEventListener('click', async () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) {
                statusEl.textContent = "保存されたデータがありません。";
                statusEl.className = 'text-sm text-gray-500 mt-2';
                return;
            }
            if (await customConfirm("保存されたデータを読み込みます。現在の入力内容は上書きされます。")) {
                try {
                    gameState = JSON.parse(savedData);
                    // 念のためデフォルトとマージ (古いデータ形式対策)
                    gameState = { ...getDefaultState(), ...gameState };
                    renderUI();
                    statusEl.textContent = "データを読み込みました。";
                    statusEl.className = 'text-sm text-blue-600 mt-2';
                } catch (e) {
                    console.error("読込に失敗しました: ", e);
                    statusEl.textContent = "データの読み込みに失敗しました。データが破損している可能性があります。";
                    statusEl.className = 'text-sm text-red-600 mt-2';
                }
            }
        });

        document.getElementById('resetData').addEventListener('click', async () => {
            if (await customConfirm("すべての入力内容をリセットします。よろしいですか？", "リセット確認")) {
                localStorage.removeItem(STORAGE_KEY);
                gameState = getDefaultState();
                renderUI();
                statusEl.textContent = "データをリセットしました。";
                statusEl.className = 'text-sm text-gray-500 mt-2';
                document.getElementById('announceOutput').textContent = "ここにアナウンス内容が表示されます。";
            }
        });


        // --- アナウンス生成ロジック ---
        function generateAnnouncement(type) {
            const output = document.getElementById('announceOutput');
            const { gameInfo, roster, gameProgress } = gameState;
            const { opponent, playOrder } = gameInfo;
            const { inning, topOrBottom } = gameProgress;
            
            let text = "";

            switch(type) {
                case "preGame":
                    text = `皆様、本日はご来場いただき、誠にありがとうございます。\n`;
                    text += `本日の試合は、${gameInfo.title || '（大会名）'}、\n`;
                    text += `${gameInfo.venue || '（試合会場）'}にて行われます。\n`;
                    text += `試合に先立ちまして、両チームのスターティングメンバー、並びに審判員をお知らせいたします。`;
                    break;

                case "startMember":
                    const ourTeamName = "（自チーム名）"; // TODO: 自チーム名入力欄を追加する
                    text = `【${playOrder === 'first' ? '先攻' : '後攻'}：${ourTeamName}】\n`;
                    roster.starting.forEach(p => {
                        text += `${p.order}番、${POSITIONS[p.position] || '（守備）'}、${p.name || '（名前）'}くん、背番号 ${p.number || '？'}番。\n`;
                    });
                    
                    text += `\n【${playOrder === 'first' ? '後攻' : '先攻'}：${opponent || '（相手チーム）'}】\n`;
                    text += `（相手チームのアナウンス）\n`;
                    text += `...（相手チームのスタメン）...\n`;
                    break;

                case "umpireIntro":
                    text = "続きまして、本日の審判員をご紹介いたします。\n";
                    text += `球審：${gameInfo.umpires.pl || '（球審）'}、\n`;
                    text += `一塁塁審：${gameInfo.umpires["1b"] || '（一塁）'}、\n`;
                    text += `二塁塁審：${gameInfo.umpires["2b"] || '（二塁）'}、\n`;
                    text += `三塁塁審：${gameInfo.umpires["3b"] || '（三塁）'}、\n`;
                    text += "以上、四氏により、本日の試合を行います。\n";
                    text += `試合開始まで、今しばらくお待ちください。`;
                    break;
                    
                case "inningStart":
                    const isOurAttack = (playOrder === 'first' && topOrBottom === 'top') || (playOrder === 'second' && topOrBottom === 'bottom');
                    
                    if (isOurAttack) {
                        text = `${inning}回 ${topOrBottom === 'top' ? '表' : '裏'}、${opponent || '（相手チーム）'}の守備をお知らせします。\n`;
                        text += `（相手チームの守備）\n`;
                        text += `（自チーム）の攻撃は、\n`;
                        // 現在の打者情報を自動でセット
                        const batter = roster.starting[gameProgress.currentBatterIndex];
                        if (batter && batter.name) {
                             text += `${batter.order}番、${POSITIONS[batter.position] || '（守備）'}、${batter.name || '（名前）'}くん。`;
                        } else {
                            text += `${gameProgress.currentBatterIndex + 1}番から...`;
                        }
                    } else {
                        text = `${inning}回 ${topOrBottom === 'top' ? '表' : '裏'}、${opponent || '（相手チーム）'}の攻撃は...\n`;
                        text += `（自チーム）の守備をお知らせします。\n`;
                        roster.starting.forEach(p => {
                            if (p.position && p.position !== 'DH') {
                                text += `${POSITIONS[p.position] || '（守備）'}、${p.name || '（名前）'}くん、\n`;
                            }
                        });
                        text = text.slice(0, -2) + "。\n"; // 最後の「、\n」を「。」に
                        text += `${opponent || '（相手チーム）'}の攻撃は、${gameProgress.currentBatterIndex + 1}番から...`;
                    }
                    break;

                case "batterUp":
                    const batter = roster.starting[gameProgress.currentBatterIndex];
                    if (batter && batter.name) {
                        text = `${batter.order}番、${POSITIONS[batter.position] || '（守備）'}、${batter.name || '（名前）'}くん。`;
                    } else {
                        text = "（打者情報がありません）";
                    }
                    break;

                case "substitution":
                    if(gameState.substitutionHistory.length === 0) {
                        text = "（まだ選手交代はありません）";
                        break;
                    }
                    // 直近の交代情報をアナウンス
                    const lastSub = gameState.substitutionHistory[gameState.substitutionHistory.length - 1];
                    text = "選手交代をお知らせします。\n";
                    text += lastSub.text;
                    break;
                    
                default:
                    text = `「${type}」のアナウンスは準備中です。`;
            }

            output.textContent = text;
            output.scrollTop = 0; // スクロールを一番上に戻す
        }

        // --- 選手交代ロジック ---

        // シンプル交代
        async function handleSimpleSubstitution() {
            const outPlayerId = document.getElementById('subOutPlayer').value;
            const inPlayerId = document.getElementById('subInPlayer').value;
            const newPosition = document.getElementById('subPosition').value;

            if (!inPlayerId || !newPosition) {
                await customConfirm("出場選手と守備位置を選択してください。", "入力エラー");
                return;
            }

            const inPlayer = gameState.roster.bench.find(p => p.id === inPlayerId);
            if (!inPlayer) {
                await customConfirm("出場選手が見つかりません。", "エラー");
                return;
            }
            
            let outPlayer = null;
            let outPlayerOriginalPosition = null;
            let announceText = "";

            if (outPlayerId) {
                // スタメンから探す
                outPlayer = gameState.roster.starting.find(p => p.id === outPlayerId);
                if (outPlayer) {
                    outPlayerOriginalPosition = outPlayer.position;
                    // TODO: 交代した選手をベンチに戻す処理。
                    // ここでは、スタメンリストからIN選手に置き換える（打順は引き継ぐ）
                    const outPlayerIndex = gameState.roster.starting.findIndex(p => p.id === outPlayerId);
                    if (outPlayerIndex > -1) {
                        
                        // 代打・代走の場合
                        if (newPosition === 'PH' || newPosition === 'PR') {
                             announceText = `【${newPosition === 'PH' ? '代打' : '代走'}】\n`;
                             announceText += `${outPlayer.order}番、${outPlayer.name}くんに代わりまして、${inPlayer.name}くん、背番号 ${inPlayer.number}番。`;
                             // 打順リストを更新
                             const oldPlayer = {...outPlayer};
                             gameState.roster.starting[outPlayerIndex] = {
                                 ...inPlayer,
                                 order: oldPlayer.order,
                                 position: newPosition // 代打/代走
                             };
                             // ベンチから削除
                             gameState.roster.bench = gameState.roster.bench.filter(p => p.id !== inPlayerId);
                             // 元の選手をベンチに追加
                             gameState.roster.bench.push({ id: oldPlayer.id, name: oldPlayer.name, number: oldPlayer.number });
                        }
                        // 守備交代の場合
                        else if (newPosition !== 'BENCH') {
                            announceText = `【守備交代】\n`;
                            announceText += `${POSITIONS[outPlayerOriginalPosition]}の${outPlayer.name}くんに代わりまして、\n`;
                            announceText += `${inPlayer.name}くんが、${POSITIONS[newPosition]}に入ります。\n`;
                            announceText += `背番号は ${inPlayer.number}番。`;
                            
                            // 打順リストを更新
                             const oldPlayer = {...outPlayer};
                             gameState.roster.starting[outPlayerIndex] = {
                                 ...inPlayer,
                                 order: oldPlayer.order,
                                 position: newPosition
                             };
                             // ベンチから削除
                             gameState.roster.bench = gameState.roster.bench.filter(p => p.id !== inPlayerId);
                             // 元の選手をベンチに追加
                             gameState.roster.bench.push({ id: oldPlayer.id, name: oldPlayer.name, number: oldPlayer.number });

                        } else {
                            // TODO: ベンチに戻る処理
                        }
                    }
                }
            } else {
                // OUTがいない場合（守備位置につくだけ？）
                // TODO: 仕様確認。ひとまずはOUT/IN必須とする。
                await customConfirm("交代する選手(OUT)も選択してください。", "入力エラー");
                return;
            }

            // 交代履歴に追加
            gameState.substitutionHistory.push({
                type: 'simple',
                outId: outPlayerId,
                inId: inPlayerId,
                position: newPosition,
                text: announceText
            });

            // UI更新
            renderUI();
            
            // アナウンス生成
            generateAnnouncement("substitution");

            // フォームリセット
            document.getElementById('subOutPlayer').value = "";
            document.getElementById('subInPlayer').value = "";
            document.getElementById('subPosition').value = "";
        }

        // 一括守備交代
        async function handleMultiSubstitution() {
            const input = document.getElementById('multiSubInput').value;
            const messageEl = document.getElementById('multiSubMessage');
            messageEl.textContent = "";

            // 入力例: "4-6, 6-4" (セカンドとショートの入れ替え)
            // 入力例: "4-3-1" (玉突き: 4->3, 3->1, 1->?)
            
            const changes = input.split(',').map(s => s.trim());
            let announceText = "【守備位置の変更】\n";
            let success = true;

            try {
                // 玉突き形式 (例: 4-3-1-2)
                if (changes.length === 1 && changes[0].includes('-')) {
                    const positions = changes[0].split('-').map(p => p.trim());
                    if(positions.length < 2) throw new Error("最低2つの守備位置が必要です。");
                    
                    const playersToMove = [];
                    // まず、移動元となる選手を特定
                    for (let i = 0; i < positions.length - 1; i++) {
                        const fromPos = positions[i];
                        const player = gameState.roster.starting.find(p => p.position === fromPos);
                        if (!player) throw new Error(`${fromPos} (${POSITIONS[fromPos]}) に選手がいません。`);
                        playersToMove.push({ player, toPos: positions[i+1] });
                    }
                    
                    // 最後の選手 (例: 4-3-1 の 1) の行き先は？
                    // 仕様では不明瞭なため、最後の選手 (1) はベンチに戻ると仮定
                    const lastPos = positions[positions.length - 1];
                    const lastPlayer = gameState.roster.starting.find(p => p.position === lastPos);
                    if (lastPlayer) {
                         playersToMove.push({ player: lastPlayer, toPos: 'BENCH' }); // 仮にベンチへ
                    }

                    // 変更を適用
                    playersToMove.forEach(({ player, toPos }) => {
                        const originalPos = player.position;
                        player.position = toPos;
                        
                        if(toPos === 'BENCH') {
                            announceText += `${POSITIONS[originalPos]}の${player.name}くんが、ベンチに下がります。\n`;
                            // TODO: ベンチへの移動ロジック (スタメンから削除、ベンチに追加)
                        } else {
                            announceText += `${POSITIONS[originalPos]}の${player.name}くんが、${POSITIONS[toPos]}に入ります。\n`;
                        }
                    });

                } 
                // 交換形式 (例: 4-6, 6-4)
                else {
                    changes.forEach(change => {
                        const parts = change.split('-');
                        if (parts.length !== 2) throw new Error(`書式が不正です: "${change}"`);
                        
                        const fromPos = parts[0].trim();
                        const toPos = parts[1].trim();
                        
                        const player = gameState.roster.starting.find(p => p.position === fromPos);
                        if (!player) throw new Error(`${fromPos} (${POSITIONS[fromPos]}) に選手がいません。`);
                        
                        // TODO: 既に行き先に選手がいる場合の処理 (例: 4-6, 6-4)
                        // このロジックだと 4->6 にした後、6(元4) -> 4 になってしまう
                        // -> 段階的ではなく、一括で処理する必要がある
                        
                        // 仮実装: 単純な移動のみ
                        player.position = toPos;
                        announceText += `${POSITIONS[fromPos]}の${player.name}くんが、${POSITIONS[toPos]}に入ります。\n`;
                    });
                }
                
                gameState.substitutionHistory.push({
                    type: 'multi',
                    text: announceText
                });

                renderUI();
                generateAnnouncement("substitution");
                document.getElementById('multiSubInput').value = "";

            } catch(e) {
                messageEl.textContent = `エラー: ${e.message}`;
                success = false;
            }
        }


        // --- 初期化 ---
        function init() {
            // デフォルト状態を読み込み
            gameState = getDefaultState();
            
            // localStorageから読み込み試行
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    // 保存されたデータをデフォルトにマージ
                    gameState = {
                        ...gameState,
                        ...parsedData,
                        gameInfo: { ...gameState.gameInfo, ...(parsedData.gameInfo || {}) },
                        roster: { ...gameState.roster, ...(parsedData.roster || {}) },
                        gameProgress: { ...gameState.gameProgress, ...(parsedData.gameProgress || {}) },
                    };
                    statusEl.textContent = "前回保存したデータを自動的に読み込みました。";
                    statusEl.className = 'text-sm text-blue-600 mt-2';
                } catch (e) {
                    console.error("自動読込失敗: ", e);
                    statusEl.textContent = "保存データの自動読込に失敗しました。";
                    statusEl.className = 'text-sm text-red-600 mt-2';
                }
            } else {
                 statusEl.textContent = "データはまだ保存されていません。";
                 statusEl.className = 'text-sm text-gray-500 mt-2';
            }

            // UIを描画
            renderUI();
        }

        // 初期化実行
        init();

    </script>
</body>
</html>