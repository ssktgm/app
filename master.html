<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マスターデータ管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem; /* p-3 p-4 */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .family-content {
            padding: 1rem; /* p-4 */
        }
        .member-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem; /* gap-2 */
        }
        @media (min-width: 768px) {
            .member-grid {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">マスターデータ管理</h1>
        <p class="mb-4 text-gray-600"><a href="index.html" class="text-blue-600 underline">&laquo; メインアプリに戻る</a></p>

        <!-- メッセージエリア -->
        <div id="message" class="hidden p-4 mb-4 border rounded-lg" role="alert">
            <span id="message-text"></span>
            <button id="message-close" type="button" class="float-right font-bold text-lg leading-none">&times;</button>
        </div>

        <!-- データインポート/エクスポート -->
        <section class="mb-6 p-4 border rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">データのエクスポート / インポート</h2>
            <div class="flex flex-wrap gap-2">
                <button id="export-master-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                    マスターを保存 (JSON)
                </button>
                <label for="import-master-input" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 cursor-pointer text-center">
                    マスターを読み込む (JSON)
                </label>
                <input type="file" id="import-master-input" class="hidden" accept=".json">
            </div>
            <p class="text-sm text-gray-500 mt-2">
                現在の家族・車・駐車場（グラウンド）の全マスターデータをJSONファイルとして保存（ダウンロード）したり、ファイルから読み込んだりできます。
            </p>
        </section>

        <!-- 家族リスト -->
        <section class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">家族データ</h2>
            <div id="family-list" class="space-y-4">
                <p id="family-loading-message" class="text-gray-500">家族データを読み込み中...</p>
                <!-- JSで描画 -->
            </div>
            <button id="add-family-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                新しい家族を追加
            </button>
        </section>

        <!-- 車リスト -->
        <section>
            <h2 class="text-xl font-semibold text-gray-700 mb-3">車データ</h2>
            <div id="car-list" class="space-y-4">
                <p id="car-loading-message" class="text-gray-500">車データを読み込み中...</p>
                <!-- JSで描画 -->
            </div>
            <button id="add-car-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                新しい車を追加
            </button>
        </section>

    </div>

    <script type="module">
        import * as db from './db.js';

        // --- DOM参照 ---
        const familyListEl = document.getElementById('family-list');
        const carListEl = document.getElementById('car-list');
        const addFamilyButton = document.getElementById('add-family-button');
        const addCarButton = document.getElementById('add-car-button');
        const exportMasterButton = document.getElementById('export-master-button');
        const importMasterInput = document.getElementById('import-master-input');
        const messageContainer = document.getElementById('message');
        const messageText = document.getElementById('message-text');
        const messageClose = document.getElementById('message-close');
        const familyLoadingMessage = document.getElementById('family-loading-message');
        const carLoadingMessage = document.getElementById('car-loading-message');

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ★ 修正: DB読み込み失敗時も考慮
            try {
                await loadFamilies();
                await loadCars();
            } catch (err) {
                console.error("マスターデータ管理ページの読み込みエラー:", err);
                familyLoadingMessage.textContent = "データの読み込みに失敗しました。";
                familyLoadingMessage.classList.add('text-red-500');
                carLoadingMessage.textContent = "データの読み込みに失敗しました。";
                carLoadingMessage.classList.add('text-red-500');
                showErrorMessage(`データベースの読み込みに失敗しました: ${err.message}`);
            }

            addFamilyButton.addEventListener('click', handleAddFamily);
            familyListEl.addEventListener('click', handleFamilyAction);
            familyListEl.addEventListener('input', handleMemberInput);

            addCarButton.addEventListener('click', handleAddCar);
            carListEl.addEventListener('click', handleCarAction);
            carListEl.addEventListener('input', handleCarInput);
            
            exportMasterButton.addEventListener('click', handleExportMasterData);
            importMasterInput.addEventListener('change', handleImportMasterData);
            messageClose.addEventListener('click', hideMessage);
        });

        // --- 家族データの読み込みと描画 ---
        async function loadFamilies() {
            try {
                const families = await db.getAllFamilies();
                families.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                renderFamilies(families);
            } catch (err) {
                console.error('Failed to load families:', err);
                familyLoadingMessage.textContent = "家族データの読み込みに失敗しました。";
                familyLoadingMessage.classList.add('text-red-500');
            }
        }

        function renderFamilies(families) {
            familyListEl.innerHTML = '';
            if (families.length === 0) {
                familyLoadingMessage.textContent = "データがありません。「新しい家族を追加」ボタンから登録してください。";
                familyListEl.appendChild(familyLoadingMessage);
                return;
            }
            families.forEach((family, index) => {
                const familyCard = renderFamily(family, index, families.length);
                familyListEl.appendChild(familyCard);
            });
        }

        function renderFamily(family, index, totalCount) {
            const familyCard = document.createElement('div');
            familyCard.className = 'bg-white border rounded-lg shadow';
            familyCard.dataset.familyId = family.familyName; // IDの代わりに名前をキーに

            const membersHtml = family.members.map(member => `
                <div class="p-2 border rounded bg-gray-50 member-grid">
                    <input type="text" data-member-id="${member.id}" data-field="name" value="${member.name}" placeholder="名前" class="col-span-3 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <select data-member-id="${member.id}" data-field="type" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                        <option value="選手" ${member.type === '選手' ? 'selected' : ''}>選手</option>
                        <option value="保護者" ${member.type === '保護者' ? 'selected' : ''}>保護者</option>
                        <option value="兄弟" ${member.type === '兄弟' ? 'selected' : ''}>兄弟</option>
                        <option value="その他" ${member.type === 'その他' ? 'selected' : ''}>その他</option>
                    </select>
                    <input type="text" data-member-id="${member.id}" data-field="data.grade" value="${member.data.grade || ''}" placeholder="学年" class="col-span-1 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.school" value="${member.data.school || ''}" placeholder="学校" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.other" value="${member.data.other || ''}" placeholder="その他" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.memo" value="${member.data.memo || ''}" placeholder="備考" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <div class="col-span-3 md:col-span-1 flex items-center justify-between">
                        <label class="text-sm flex items-center">
                            <input type="checkbox" data-member-id="${member.id}" data-field="isFlagTarget" class="mr-1 rounded shadow-sm" ${member.isFlagTarget ? 'checked' : ''}>
                            同乗優先
                        </label>
                        <button data-action="delete-member" data-member-id="${member.id}" class="text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">削除</button>
                    </div>
                </div>
            `).join('');

            // ★ 新規: 並び替えボタンのHTML
            const moveUpDisabled = (index === 0) ? 'disabled' : '';
            const moveDownDisabled = (index === totalCount - 1) ? 'disabled' : '';
            const moveButtons = `
                <div class="flex flex-col space-y-1">
                    <button data-action="move-up" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-1 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveUpDisabled}>▲ 上へ</button>
                    <button data-action="move-down" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-1 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveDownDisabled}>▼ 下へ</button>
                </div>
            `;
            
            familyCard.innerHTML = `
                <div class="family-header">
                    <input type="text" data-action="rename-family" value="${family.familyName}" class="text-lg font-semibold p-1 border rounded shadow-sm">
                    <div class="flex items-center space-x-2">
                        ${moveButtons} <!-- ★ 並び替えボタンを追加 -->
                        <button data-action="delete-family" class="text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">家族を削除</button>
                    </div>
                </div>
                <div class="family-content">
                    <div class="space-y-2 mb-3">
                        ${membersHtml}
                    </div>
                    <button data-action="add-member" class="text-sm bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">
                        ＋ メンバー追加
                    </button>
                </div>
            `;
            return familyCard;
        }
        
        // --- 家族データの操作 ---
        async function handleAddFamily() {
            const newFamilyName = prompt("新しい家族名を入力してください (例: 鈴木家)");
            if (!newFamilyName || newFamilyName.trim() === '') {
                showWarningMessage("家族名が入力されていません。");
                return;
            }
            try {
                const existingFamily = await db.getFamily(newFamilyName);
                if (existingFamily) {
                    showErrorMessage(`家族名「${newFamilyName}」は既に使用されています。`);
                    return;
                }
                
                // ★ 新規: order を計算
                const families = await db.getAllFamilies();
                const maxOrder = families.reduce((max, f) => Math.max(max, f.order ?? 0), 0);

                const newFamily = {
                    familyName: newFamilyName,
                    order: maxOrder + 1, // ★ order を設定
                    members: [
                        {
                            id: `p${Date.now()}`,
                            name: "新しいメンバー",
                            type: "選手",
                            isFlagTarget: true,
                            data: { grade: "", school: "", other: "", memo: "" }
                        }
                    ]
                };
                await db.addFamily(newFamily);
                await loadFamilies();
                showSuccessMessage(`家族「${newFamilyName}」を追加しました。`);
            } catch (err) {
                console.error('Failed to add family:', err);
                showErrorMessage('家族の追加に失敗しました。');
            }
        }

        async function handleFamilyAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const familyCard = target.closest('[data-family-id]');
            if (!familyCard) return;
            
            const familyName = familyCard.dataset.familyId;

            try {
                const family = await db.getFamily(familyName);
                if (!family) {
                    showErrorMessage('対象の家族データが見つかりません。');
                    await loadFamilies();
                    return;
                }

                if (action === 'delete-family') {
                    if (confirm(`本当に「${familyName}」を削除しますか？`)) {
                        await db.deleteFamily(familyName);
                        await loadFamilies();
                        showSuccessMessage(`家族「${familyName}」を削除しました。`);
                    }
                } else if (action === 'add-member') {
                    const newMember = {
                        id: `p${Date.now()}`,
                        name: "新しいメンバー",
                        type: "保護者",
                        isFlagTarget: false,
                        data: { grade: "", school: "", other: "", memo: "" }
                    };
                    family.members.push(newMember);
                    await db.updateFamily(family);
                    await loadFamilies(); // 再描画
                    showSuccessMessage('メンバーを追加しました。');
                } else if (action === 'delete-member') {
                    const memberId = target.dataset.memberId;
                    if (confirm("本当にこのメンバーを削除しますか？")) {
                        family.members = family.members.filter(m => m.id !== memberId);
                        await db.updateFamily(family);
                        await loadFamilies(); // 再描画
                        showSuccessMessage('メンバーを削除しました。');
                    }
                } else if (action === 'rename-family') {
                    target.addEventListener('change', async (event) => {
                        const newName = event.target.value.trim();
                        if (newName === '' || newName === familyName) {
                            event.target.value = familyName; // 元に戻す
                            return;
                        }
                        
                        const existing = await db.getFamily(newName);
                        if (existing) {
                            event.target.value = familyName; // 元に戻す
                            showErrorMessage(`家族名「${newName}」は既に使用されています。`);
                            return;
                        }

                        // 元のデータを削除し、新しい名前で追加（実質的なリネーム）
                        await db.deleteFamily(familyName);
                        family.familyName = newName;
                        await db.addFamily(family); // 新しい名前で追加
                        
                        familyCard.dataset.familyId = newName; // DOMのIDも更新
                        showSuccessMessage('家族名を変更しました。');
                    }, { once: true }); // イベントリスナーを一度だけ実行
                }
                
                // ★ 新規: 並び替え処理
                if (action === 'move-up' || action === 'move-down') {
                    try {
                        const families = (await db.getAllFamilies()).sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                        const currentIndex = families.findIndex(f => f.familyName === familyName);
                        
                        if (currentIndex === -1) return;

                        const targetIndex = (action === 'move-up') ? currentIndex - 1 : currentIndex + 1;
                        
                        if (targetIndex >= 0 && targetIndex < families.length) {
                            const familyA = families[currentIndex];
                            const familyB = families[targetIndex];
                            
                            // orderプロパティを入れ替える
                            const tempOrder = familyA.order;
                            familyA.order = familyB.order;
                            familyB.order = tempOrder;
                            
                            // DB更新
                            await db.updateFamily(familyA);
                            await db.updateFamily(familyB);
                            
                            // 画面再描画
                            await loadFamilies();
                            showSuccessMessage('並び順を変更しました');
                        }
                    } catch (err) {
                        console.error('Failed to reorder family:', err);
                        showErrorMessage('並び順の変更に失敗しました。');
                    }
                }

            } catch (err) {
                console.error('Family action failed:', err);
                showErrorMessage('操作に失敗しました。');
            }
        }

        async function handleMemberInput(e) {
            const target = e.target;
            const memberId = target.dataset.memberId;
            const field = target.dataset.field;
            if (!memberId || !field) return;

            const familyName = target.closest('[data-family-id]').dataset.familyId;
            
            try {
                const family = await db.getFamily(familyName);
                if (!family) return;

                const member = family.members.find(m => m.id === memberId);
                if (!member) return;

                let value;
                if (target.type === 'checkbox') {
                    value = target.checked;
                } else {
                    value = target.value;
                }

                // data.grade のようなネストしたプロパティに対応
                if (field.startsWith('data.')) {
                    const dataField = field.split('.')[1];
                    member.data[dataField] = value;
                } else {
                    member[field] = value;
                }

                await db.updateFamily(family);
                // console.log("Member updated:", member); // デバッグ用
            } catch (err) {
                console.error('Failed to update member:', err);
                showErrorMessage('メンバー情報の更新に失敗しました。');
            }
        }

        // --- 車データの読み込みと描画 ---
        async function loadCars() {
            try {
                const cars = await db.getAllCars();
                cars.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                renderCars(cars);
            } catch (err) {
                console.error('Failed to load cars:', err);
                carLoadingMessage.textContent = "車データの読み込みに失敗しました。";
                carLoadingMessage.classList.add('text-red-500');
            }
        }

        function renderCars(cars) {
            carListEl.innerHTML = '';
            if (cars.length === 0) {
                carLoadingMessage.textContent = "データがありません。「新しい車を追加」ボタンから登録してください。";
                carListEl.appendChild(carLoadingMessage);
                return;
            }
            
            cars.forEach((car, index) => {
                const carCard = document.createElement('div');
                carCard.className = 'p-4 border rounded-lg bg-gray-50 flex flex-wrap gap-4 items-center';
                carCard.dataset.carId = car.id;
                
                // ★ 新規: 並び替えボタン
                const moveUpDisabled = (index === 0) ? 'disabled' : '';
                const moveDownDisabled = (index === cars.length - 1) ? 'disabled' : '';
                const moveButtons = `
                    <div class="flex flex-col space-y-1">
                        <button data-action="move-up" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-1 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveUpDisabled}>▲ 上へ</button>
                        <button data-action="move-down" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-1 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveDownDisabled}>▼ 下へ</button>
                    </div>
                `;

                carCard.innerHTML = `
                    ${moveButtons} <!-- ★ 並び替えボタンを追加 -->
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">車ID</label>
                        <input type="text" data-field="id" value="${car.id}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm bg-gray-200" readonly>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">車の名称</label>
                        <input type="text" data-field="name" value="${car.name}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">関連家族名</label>
                        <input type="text" data-field="familyName" value="${car.familyName}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="flex-1 min-w-[100px]">
                        <label class="block text-sm font-medium text-gray-700">基本定員</label>
                        <input type="number" data-field="baseCapacity" value="${car.baseCapacity}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="ml-auto">
                        <button data-action="delete-car" class="text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded">削除</button>
                    </div>
                `;
                carListEl.appendChild(carCard);
            });
        }

        // --- 車データの操作 ---
        async function handleAddCar() {
            // ★ 修正: ID自動生成
            const newCarId = `c${Date.now()}`;
            
            try {
                // ★ 新規: order を計算
                const cars = await db.getAllCars();
                const maxOrder = cars.reduce((max, c) => Math.max(max, c.order ?? 0), 0);
                
                const newCar = {
                    id: newCarId,
                    name: "新しい車",
                    familyName: "スタッフ・個人",
                    baseCapacity: 5,
                    order: maxOrder + 1 // ★ order を設定
                };
                await db.addCar(newCar);
                await loadCars();
                showSuccessMessage(`車「${newCar.name}」を追加しました。`);
            } catch (err) {
                console.error('Failed to add car:', err);
                showErrorMessage('車の追加に失敗しました。');
            }
        }

        async function handleCarAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const carCard = target.closest('[data-car-id]');
            if (!carCard) return;

            const carId = carCard.dataset.carId;

            try {
                if (action === 'delete-car') {
                    if (confirm(`本当に車(ID: ${carId})を削除しますか？`)) {
                        await db.deleteCar(carId);
                        await loadCars();
                        showSuccessMessage(`車(ID: ${carId})を削除しました。`);
                    }
                }
                
                // ★ 新規: 並び替え処理
                if (action === 'move-up' || action === 'move-down') {
                    try {
                        const cars = (await db.getAllCars()).sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                        const currentIndex = cars.findIndex(c => c.id === carId);
                        
                        if (currentIndex === -1) return;

                        const targetIndex = (action === 'move-up') ? currentIndex - 1 : currentIndex + 1;
                        
                        if (targetIndex >= 0 && targetIndex < cars.length) {
                            const carA = cars[currentIndex];
                            const carB = cars[targetIndex];
                            
                            // orderプロパティを入れ替える
                            const tempOrder = carA.order;
                            carA.order = carB.order;
                            carB.order = tempOrder;
                            
                            // DB更新
                            await db.updateCar(carA);
                            await db.updateCar(carB);
                            
                            // 画面再描画
                            await loadCars();
                            showSuccessMessage('並び順を変更しました');
                        }
                    } catch (err) {
                        console.error('Failed to reorder car:', err);
                        showErrorMessage('並び順の変更に失敗しました。');
                    }
                }

            } catch (err) {
                console.error('Car action failed:', err);
                showErrorMessage('操作に失敗しました。');
            }
        }

        async function handleCarInput(e) {
            const target = e.target;
            const field = target.dataset.field;
            if (!field || field === 'id') return; // IDは変更不可

            const carId = target.closest('[data-car-id]').dataset.carId;
            
            try {
                const car = await db.getCar(carId);
                if (!car) return;

                let value = target.value;
                if (target.type === 'number') {
                    value = parseInt(value, 10);
                }
                
                car[field] = value;

                await db.updateCar(car);
                // console.log("Car updated:", car); // デバッグ用
            } catch (err) {
                console.error('Failed to update car:', err);
                showErrorMessage('車情報の更新に失敗しました。');
            }
        }
        
        // --- インポート/エクスポート ---
        async function handleExportMasterData() {
            try {
                // ★ 修正: 駐車場データも取得
                const families = await db.getAllFamilies();
                const cars = await db.getAllCars();
                const parking = await db.getAllSavedParking(); // 駐車場データを取得
                
                const masterData = { 
                    families: families, 
                    cars: cars,
                    parking: parking // ★ 駐車場データを追加
                }; 
                const jsonString = JSON.stringify(masterData, null, 2); 
                
                const blob = new Blob([jsonString], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = `car_assignment_master_${new Date().toISOString().slice(0,10)}.json`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
                showSuccessMessage('現在のマスターデータをファイルに保存しました。');
            } catch (err) {
                 console.error('Failed to export master data:', err);
                showErrorMessage('マスターデータのエクスポートに失敗しました。');
            }
        }
        
        function handleImportMasterData(e) {
             const file = e.target.files[0];
             if (!file) return;
             
             const reader = new FileReader();

             reader.onload = async (event) => {
                 try {
                     const masterData = JSON.parse(event.target.result);

                    if (!masterData || !Array.isArray(masterData.families) || !Array.isArray(masterData.cars)) {
                        throw new Error('JSONの形式が正しくありません。 "families" と "cars" の配列が必須です。');
                    }
                     
                     // ★ 新規: インポートデータにorderを付与 (ない場合)
                     masterData.families.forEach((f, i) => {
                         if (f.order === undefined) f.order = i + 1;
                     });
                     masterData.cars.forEach((c, i) => {
                         if (c.order === undefined) c.order = i + 1;
                     });
                     
                     // 既存のデータをクリア
                     await db.clearStore('families');
                     await db.clearStore('cars');
                     
                     // 新しいデータをバルク追加
                     await db.bulkAddFamilies(masterData.families);
                     await db.bulkAddCars(masterData.cars);

                     // ★ 新規: 駐車場データもインポート (任意)
                     if (masterData.parking && Array.isArray(masterData.parking)) {
                         await db.clearStore('savedParking');
                         // 形式が古くないか確認しつつ追加
                         for (const park of masterData.parking) {
                             if (park.name && park.parking) {
                                 await db.addParking(park); // db.js の addParking を使う
                             }
                         }
                     }

                     await loadFamilies();
                     await loadCars();
                     
                     showSuccessMessage('マスターデータを読み込みました。');
                 } catch (err) { 
                     console.error('Error parsing master data JSON:', err); 
                     showErrorMessage(`マスターデータの読み込みに失敗しました: ${err.message}`); 
                 } 
                 e.target.value = null; 
             };
             reader.readAsText(file);
        }

        // --- メッセージ表示 ---
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }
        function showWarningMessage(message) {
            showMessage(message, 'warning');
        }
        function showErrorMessage(message) {
            showMessage(message, 'error');
        }
        
        function showMessage(message, type = 'info'){ 
            messageText.innerHTML = message; 
            messageContainer.className = 'p-4 mb-4 border rounded-lg'; 
            switch(type) {
                case 'error': messageContainer.classList.add('bg-red-100', 'border-red-400', 'text-red-700'); break;
                case 'warning': messageContainer.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700'); break;
                case 'success': messageContainer.classList.add('bg-green-100', 'border-green-400', 'text-green-700'); break;
                default: messageContainer.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageContainer.classList.remove('hidden');
        }
        function hideMessage(){ 
            messageContainer.classList.add('hidden');
        }
    </script>

</body>
</html>