<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…è»Šèª¿æ•´ã‚¢ãƒ—ãƒª (DnDç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="é…è»Šèª¿æ•´">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <style>
        /* details[open] summary ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        details[open] > summary {
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        /* ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’éš ã™ */
        #import-state-input, #import-master-input {
            display: none;
        }

        /* å¯å¤‰ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãŸã‚ã®CSS */
        .main-grid-layout {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* default: 1 col */
            gap: 1.5rem; /* gap-6 */
        }
        
        /* çµæœè¡¨ç¤ºç”¨ã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (é§è»Šå ´ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ä½¿ç”¨) */
        .results-grid-layout {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* default: 1 col */
            gap: 1rem; /* gap-4 */
        }

        @media (min-width: 768px) { /* md: breakpoint */
            .main-grid-layout {
                grid-template-columns: repeat(var(--layout-columns, 3), minmax(0, 1fr));
            }
             .results-grid-layout {
                 grid-template-columns: repeat(var(--layout-columns, 3), minmax(0, 1fr));
             }
        }
        
        /* é¸æŠä¸­ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .swap-selected {
            background-color: #DBEAFE; /* blue-100 */
        }
        .swap-selected > label, .swap-selected label { 
            font-weight: 600; 
            color: #1D4ED8; 
        }
        .car-header.swap-selected {
             background-color: #DBEAFE; 
        }
        .car-header.swap-selected h4 {
            color: #1D4ED8; 
        }

        /* DBæ“ä½œãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’çµ±ä¸€ */
        .db-control {
            padding: 0.25rem 0.5rem;
            height: 1.75rem;
            font-size: 0.75rem;
            box-sizing: border-box; 
            vertical-align: middle;
        }
        select.db-control {
             line-height: 1.25;
        }
        
        /* ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */
        @media (min-width: 768px) { 
            #header-area {
                position: sticky;
                top: 0;
                z-index: 50;
                background-color: #f3f4f6; /* bg-gray-100 */
                padding-bottom: 0.5rem;
            }
            body {
                scroll-padding-top: 14rem; 
            }
        }
        
        #data-controls-details > summary {
            list-style: none; 
        }
        #data-controls-details > summary::-webkit-details-marker {
            display: none; 
        }

        /* --- SortableJS é–¢é€£ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c7d2fe; /* indigo-200 */
            border: 2px dashed #4f46e5; /* indigo-600 */
        }
        .sortable-chosen {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .sortable-drag {
            cursor: grabbing;
            opacity: 1 !important;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ  */
        .draggable-item {
            cursor: grab;
            transition: background-color 0.2s, transform 0.1s;
        }
        .draggable-item:active {
            cursor: grabbing;
        }
        /* ãƒ‰ãƒ­ãƒƒãƒ—ç¦æ­¢æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sortable-reject {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #ef4444 !important; /* red-500 */
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        #status-bar {
            transition: all 0.3s ease;
        }
        #status-bar.warning {
            background-color: #FEE2E2; /* red-100 */
            border-color: #F87171; /* red-400 */
            color: #991B1B; /* red-800 */
        }
        #status-bar.safe {
            background-color: #D1FAE5; /* green-100 */
            border-color: #34D399; /* green-400 */
            color: #065F46; /* green-800 */
        }

    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">é…è»Šèª¿æ•´ <span class="text-sm font-normal text-gray-500 ml-2">Ver.2 (DnDå¯¾å¿œ)</span></h1>
            <a href="./manual.html" target="_blank" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg shadow transition duration-200">
                ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
            </a>
        </div>

        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ (ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼) -->
        <div id="header-area">
            <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
            <section id="data-controls-section" class="mb-4 bg-white p-4 rounded-lg shadow">
                <details id="data-controls-details">
                    <summary class="text-lg font-semibold text-gray-700 cursor-pointer select-none flex justify-between items-center">
                        <span>ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
                        <span class="text-xs text-gray-400">â–¼ ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰</span>
                    </summary>

                    <div class="pt-3 border-t mt-2">
                        <!-- (å†…å®¹ã¯index.htmlã¨åŒã˜) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4">
                            <!-- â‘  é…è»Šãƒ‡ãƒ¼ã‚¿ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">â‘  é…è»Šãƒ‡ãƒ¼ã‚¿</label>
                                <div class="flex space-x-2">
                                    <button id="save-state-db-button" class="db-control w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">ä¿å­˜</button>
                                    <select id="saved-state-select" class="db-control w-2/3 block p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option value="">ä½œæ¥­ä¸€è¦§...</option></select>
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    <button id="load-state-db-button" class="db-control w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-3 rounded-lg shadow transition duration-200">èª­è¾¼</button>
                                    <button id="delete-state-db-button" class="db-control w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">å‰Šé™¤</button>
                                </div>
                            </div>
                            <!-- â‘¡ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»é§è»Šå ´ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">â‘¡ ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»é§è»Šå ´</label>
                                <div class="flex space-x-2">
                                    <button id="save-parking-db-button" class="db-control w-1/3 bg-blue-600 hover:bg-blue-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">ä¿å­˜</button>
                                    <select id="saved-parking-select" class="db-control w-2/3 block p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><option value="">ä¸€è¦§...</option></select>
                                </div>
                                <div class="flex space-x-2 mt-2">
                                    <button id="load-parking-db-button" class="db-control w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-3 rounded-lg shadow transition duration-200">èª­è¾¼</button>
                                    <button id="delete-parking-db-button" class="db-control w-1/2 bg-red-600 hover:bg-red-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">å‰Šé™¤</button>
                                </div>
                            </div>
                            <!-- â‘¢ ãƒ•ã‚¡ã‚¤ãƒ« -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">â‘¢ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­è¾¼</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="export-state-button" class="db-control bg-green-600 hover:bg-green-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">ä¿å­˜(DL)</button>
                                    <label for="import-state-input" class="db-control bg-green-200 hover:bg-green-300 text-green-800 font-bold px-3 rounded-lg shadow transition duration-200 cursor-pointer text-center leading-tight">èª­è¾¼(UL)</label>
                                    <input type="file" id="import-state-input" accept=".json">
                                </div>
                            </div>
                            <!-- â‘£ ç®¡ç† -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">â‘£ ã‚¢ãƒ—ãƒªç®¡ç†</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <a href="master.html" target="_blank" class="db-control text-center bg-gray-600 hover:bg-gray-700 text-white font-bold px-3 rounded-lg shadow transition duration-200">ãƒã‚¹ã‚¿ãƒ¼ç·¨é›†</a>
                                    <button id="clear-db-button" class="db-control bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 rounded-lg shadow transition duration-200">ãƒªã‚»ãƒƒãƒˆ</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div id="message" class="hidden p-4 h-full border rounded-lg max-h-48 overflow-y-auto" role="alert">
                                <span id="message-text"></span>
                                <button id="message-close" type="button" class="float-right font-bold text-lg leading-none">Ã—</button>
                            </div>
                        </div>
                    </div>
                </details>
            </section>

            <!-- â˜…â˜…â˜… æ–°è¦: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ â˜…â˜…â˜… -->
            <div id="status-bar" class="safe border rounded-lg shadow p-3 mb-6 flex flex-col md:flex-row justify-between items-center sticky top-0 z-40">
                <div class="flex items-center space-x-4">
                    <div class="text-center md:text-left">
                        <span class="block text-xs text-gray-500">å‚åŠ äºˆå®šäººæ•°</span>
                        <span class="text-2xl font-bold" id="status-participants-count">0</span>
                        <span class="text-sm">å</span>
                    </div>
                    <div class="text-2xl font-light text-gray-400">/</div>
                    <div class="text-center md:text-left">
                        <span class="block text-xs text-gray-500">è»Šã®ç·å®šå“¡</span>
                        <span class="text-2xl font-bold" id="status-cars-capacity">0</span>
                        <span class="text-sm">å</span>
                    </div>
                </div>
                
                <div class="mt-2 md:mt-0 flex items-center bg-white/50 px-4 py-2 rounded-full">
                    <span class="text-sm font-bold mr-2">æ®‹ã‚Šæ :</span>
                    <span id="status-balance" class="text-xl font-bold">0</span>
                    <span class="text-sm ml-1">ååˆ†</span>
                </div>
            </div>
        </div>


        <div id="main-content" class="main-grid-layout">

            <!-- 1. ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ± -->
            <section class="md:col-span-3">
                 <h2 class="text-xl font-semibold text-gray-700 mb-3">1. ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-white p-4 rounded-lg shadow">
                     <div>
                        <label for="event-date" class="block text-sm font-medium text-gray-700">ã‚¤ãƒ™ãƒ³ãƒˆæ—¥</label>
                        <input type="text" id="event-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="2025/11/3(ç¥)">
                     </div>
                     <div class="md:col-span-2">
                        <label for="event-name" class="block text-sm font-medium text-gray-700">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                        <input type="text" id="event-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="vsæµå±±ãƒãƒªãƒ¼ãƒ³ã‚º(ç·´ç¿’è©¦åˆ)">
                     </div>
                 </div>
            </section>
            
            <!-- 2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
            <section class="md:col-span-3">
                 <h2 class="text-xl font-semibold text-gray-700 mb-3">2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ»ç‰¹è¨˜äº‹é …</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-4 rounded-lg shadow">
                     <div>
                        <label for="event-timeline" class="block text-sm font-medium text-gray-700">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</label>
                        <textarea id="event-timeline" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="æ±å°é›†åˆ 8:30..."></textarea>
                     </div>
                     <div>
                        <label for="event-notes" class="block text-sm font-medium text-gray-700">ç‰¹è¨˜äº‹é …</label>
                        <textarea id="event-notes" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="ãŠå¼å½“ã€ãƒãƒŠãƒ¼ãƒ‘ãƒ³ãƒ„..."></textarea>
                    </div>
                 </div>
            </section>

            <!-- 3. é§è»Šå ´ -->
            <section class="md:col-span-3">
                 <h2 class="text-xl font-semibold text-gray-700 mb-3">3. ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ»é§è»Šå ´æƒ…å ±</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-4 rounded-lg shadow">
                     <div>
                        <label for="ground-name" class="block text-sm font-medium text-gray-700">ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å</label>
                        <input type="text" id="ground-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="ä¾‹: æ±è°·ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰">
                        
                        <label for="parking-designated-name" class="block text-sm font-medium text-gray-700 mt-3">æŒ‡å®šé§è»Šå ´</label>
                        <div class="flex gap-2">
                            <input type="text" id="parking-designated-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="åç§° (ä¾‹: Aé¢)">
                            <input type="number" id="parking-designated-limit" class="mt-1 block w-24 p-2 border border-gray-300 rounded-md shadow-sm" placeholder="å°æ•°">
                        </div>
                        <textarea id="parking-designated-memo" rows="2" class="mt-2 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="å‚™è€ƒ (åœ°å›³URLãªã©)"></textarea>
                     </div>
                     <div>
                        <label for="parking-other-name" class="block text-sm font-medium text-gray-700">æŒ‡å®šä»¥å¤–ã®é§è»Šå ´</label>
                        <input type="text" id="parking-other-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="åç§° (ä¾‹: ä¸˜ã®ä¸Š)">
                        <textarea id="parking-other-memo" rows="2" class="mt-2 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="å‚™è€ƒ"></textarea>
                     </div>
                 </div>
            </section>

            <!-- 4. å‚åŠ è€… -->
            <section>
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">4. å‚åŠ è€…</h2>
                    <button id="toggle-details-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded-lg text-sm transition duration-200">é–‰ã˜ã‚‹</button>
                </div>
                <div id="participant-list" class="space-y-2 h-[500px] overflow-y-auto bg-white p-4 rounded-lg shadow">
                    <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </section>

            <!-- 5. è»Š -->
            <section>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">5. è»Šã¨ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</h2>
                <div id="car-list" class="space-y-3 h-[500px] overflow-y-auto bg-white p-4 rounded-lg shadow">
                    <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </section>

            <!-- 6. åˆ¥ä¾¿ -->
            <section>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">6. åˆ¥ä¾¿ (ç¾åœ°é›†åˆãªã©)</h2>
                <div id="exclusion-list" class="space-y-2 h-[500px] overflow-y-auto bg-white p-4 rounded-lg shadow">
                    <p class="text-gray-500 text-sm">ã‚¹ãƒ†ãƒƒãƒ—4ã§å‚åŠ è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </section>

            <!-- å‰²ã‚Šå½“ã¦å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
            <section class="md:col-span-3 text-center py-4">
                <button id="assign-button" class="w-full md:w-2/3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-200 ease-in-out transform hover:scale-105 text-xl flex justify-center items-center gap-2">
                    <span>ğŸš€ å‰²ã‚Šå½“ã¦å®Ÿè¡Œ</span>
                </button>
                <p class="text-sm text-gray-500 mt-2">â€»è‡ªå‹•å‰²ã‚Šå½“ã¦ã‚’å®Ÿè¡Œã—ã€çµæœã‚’è¡¨ç¤ºã—ã¾ã™</p>
            </section>

            <!-- 7. çµæœ -->
            <section id="results-section" class="md:col-span-3"> 
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h2 class="text-xl font-semibold text-gray-700">7. å‰²ã‚Šå½“ã¦çµæœ</h2>
                    <div class="flex gap-2">
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hidden md:inline-block">ãƒ‰ãƒ©ãƒƒã‚°ã§å…¥æ›¿å¯</span>
                        <button id="show-text-output-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg shadow text-sm transition duration-200">
                            ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›
                        </button>
                    </div>
                </div>
                
                <div id="text-output-container" class="mb-4 hidden">
                    <textarea id="text-output" rows="15" class="w-full p-2 border rounded-lg font-mono text-sm bg-gray-50" readonly></textarea>
                    <button id="copy-text-output-button" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm">ã‚³ãƒ”ãƒ¼</button>
                </div>

                <div id="results" class="space-y-6 pb-20"> 
                    <p id="results-placeholder" class="text-gray-500 text-center py-10 bg-white rounded-lg border border-dashed border-gray-300">
                        ã€Œå‰²ã‚Šå½“ã¦å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                        ãã®å¾Œã€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§äººã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                    </p>
                </div>
            </section>
            
            <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ (ã‚¹ãƒãƒ›ç”¨) -->
            <div class="fixed bottom-6 right-6 md:hidden z-50">
                 <button id="fab-text-output" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-4 shadow-lg hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                 </button>
            </div>

        </div> 
    </div>

    <script type="module">
        import * as db from './db.js';
        
        // --- å®šæ•°ãƒ»å¤‰æ•° ---
        const LAYOUT_COLUMNS = 3; 
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆDBãŒç©ºã®æ™‚ç”¨ï¼‰
        const DEFAULT_FAMILIES = [ /* index.htmlã¨åŒã˜å†…å®¹ãªã®ã§çœç•¥å¯ã ãŒã€å‹•ä½œä¿è¨¼ã®ãŸã‚æœ€ä½é™å®šç¾© */ ];
        const DEFAULT_CARS = [ /* åŒä¸Š */ ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let FAMILIES = [];
        let AVAILABLE_CARS_INFO = [];
        let ALL_PARTICIPANTS_FLAT = [];

        // çŠ¶æ…‹å¤‰æ•°
        let selectedParticipantIds = new Set();
        let selectedCarIds = new Set();
        let selectedDrivers = new Map(); // carId -> driverId
        let selectedLuggage = new Set(); 
        let excludedParticipantIds = new Set();
        let participantData = new Map(); 
        
        let parkingInfo = { groundName: '', designated: { name: '', limit: 0, memo: '' }, other: { name: '', memo: '' } };
        let eventInfo = { date: '', name: '', timeline: '', notes: '' };
        let currentAssignments = []; 

        // DOMè¦ç´ 
        const els = {
            participantList: document.getElementById('participant-list'),
            carList: document.getElementById('car-list'),
            exclusionList: document.getElementById('exclusion-list'),
            results: document.getElementById('results'),
            assignButton: document.getElementById('assign-button'),
            textOutput: document.getElementById('text-output'),
            textOutputContainer: document.getElementById('text-output-container'),
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼
            statusParticipants: document.getElementById('status-participants-count'),
            statusCapacity: document.getElementById('status-cars-capacity'),
            statusBalance: document.getElementById('status-balance'),
            statusBar: document.getElementById('status-bar'),

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            eventDate: document.getElementById('event-date'),
            eventName: document.getElementById('event-name'),
            eventTimeline: document.getElementById('event-timeline'),
            eventNotes: document.getElementById('event-notes'),
            groundName: document.getElementById('ground-name'),
            pDesName: document.getElementById('parking-designated-name'),
            pDesLimit: document.getElementById('parking-designated-limit'),
            pDesMemo: document.getElementById('parking-designated-memo'),
            pOtherName: document.getElementById('parking-other-name'),
            pOtherMemo: document.getElementById('parking-other-memo'),
            
            // DBæ“ä½œç³»
            savedStateSelect: document.getElementById('saved-state-select'),
            savedParkingSelect: document.getElementById('saved-parking-select'),
            messageContainer: document.getElementById('message'),
            messageText: document.getElementById('message-text')
        };

        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateLayouts();
            window.addEventListener('resize', updateLayouts); 

            try {
                await loadMasterDataFromDB();
                if(FAMILIES.length === 0) {
                    // ãƒã‚¹ã‚¿ãŒç©ºãªã‚‰ã¨ã‚Šã‚ãˆãšç©ºã§åˆæœŸåŒ– (index.htmlã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ã¯çœç•¥)
                    els.participantList.innerHTML = '<p>ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    initializeParticipantData(); 
                    renderParticipantList();
                    renderCarList();
                    renderExclusionList();
                }
                await loadSavedStatesList();
                await loadSavedParkingList();
                updateStatusCounter(); // åˆæœŸè¨ˆç®—

            } catch (err) {
                console.error(err);
                showMessage('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
            
            // PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js');
            }
        });

        function updateLayouts() {
            if (window.innerWidth >= 768) { 
                document.getElementById('main-content').style.gridTemplateColumns = `repeat(${LAYOUT_COLUMNS}, minmax(0, 1fr))`;
                document.getElementById('results-section').style.gridColumn = `span ${LAYOUT_COLUMNS}`;
            } else {
                document.getElementById('main-content').style.gridTemplateColumns = 'repeat(1, minmax(0, 1fr))';
                document.getElementById('results-section').style.gridColumn = 'auto';
            }
        }

        // --- DBé–¢é€£ (ç°¡æ˜“ç‰ˆ) ---
        async function loadMasterDataFromDB() {
            // db.jsã®é–¢æ•°ã‚’åˆ©ç”¨
            const families = await db.getAllFamilies();
            const cars = await db.getAllCars();
            
            FAMILIES = families.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
            AVAILABLE_CARS_INFO = cars.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
            ALL_PARTICIPANTS_FLAT = FAMILIES.flatMap(f => f.members);
        }

        function initializeParticipantData() {
            participantData.clear(); 
            FAMILIES.forEach(family => {
                family.members.forEach(member => {
                    const defaultData = { grade: '', school: '', other: '', memo: '', ...(member.data || {}) };
                    if (!member.isFlagTarget) { defaultData.grade = ''; defaultData.school = ''; defaultData.other = ''; }
                    participantData.set(member.id, defaultData);
                });
            });
        }

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---

        // å‚åŠ è€…ãƒªã‚¹ãƒˆ
        function renderParticipantList() {
            els.participantList.innerHTML = '';
            FAMILIES.forEach(family => {
                const details = document.createElement('details');
                details.className = 'bg-gray-50 rounded border group';
                details.open = true;
                
                // å…¨å“¡å‚åŠ /ä¸å‚åŠ ãƒœã‚¿ãƒ³
                const summary = document.createElement('summary');
                summary.className = 'p-3 cursor-pointer select-none flex justify-between items-center outline-none';
                summary.innerHTML = `
                    <span class="font-semibold">${family.familyName}</span>
                    <div class="space-x-1">
                        <button type="button" data-family="${family.familyName}" data-action="check-all" class="text-xs bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded">å…¨å‚åŠ </button>
                        <button type="button" data-family="${family.familyName}" data-action="uncheck-all" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-1 px-2 rounded">å…¨è§£é™¤</button>
                    </div>
                `;
                
                const listDiv = document.createElement('div');
                listDiv.className = 'p-2 space-y-2 border-t';

                family.members.forEach(p => {
                    const isChecked = selectedParticipantIds.has(p.id);
                    const div = document.createElement('div');
                    div.className = 'pl-2';
                    
                    const data = participantData.get(p.id) || {};
                    const disabled = !isChecked ? 'disabled' : '';
                    const opacity = !isChecked ? 'opacity-50' : '';

                    // å±æ€§å…¥åŠ›æ¬„
                    let extraInputs = '';
                    if (p.isFlagTarget) {
                        extraInputs = `
                            <div class="mt-1 grid grid-cols-3 gap-1 ${opacity}" id="data-${p.id}">
                                <input type="text" data-id="${p.id}" data-type="grade" value="${data.grade}" placeholder="å­¦å¹´" class="text-xs p-1 border rounded" ${disabled}>
                                <input type="text" data-id="${p.id}" data-type="school" value="${data.school}" placeholder="å­¦æ ¡" class="text-xs p-1 border rounded" ${disabled}>
                                <input type="text" data-id="${p.id}" data-type="memo" value="${data.memo}" placeholder="å‚™è€ƒ" class="text-xs p-1 border rounded" ${disabled}>
                            </div>`;
                    } else {
                         extraInputs = `
                            <div class="mt-1 ${opacity}" id="data-${p.id}">
                                <input type="text" data-id="${p.id}" data-type="memo" value="${data.memo}" placeholder="å‚™è€ƒ" class="text-xs p-1 border rounded w-full" ${disabled}>
                            </div>`;
                    }

                    div.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" id="p-${p.id}" data-id="${p.id}" class="participant-check mr-2 h-4 w-4 text-blue-600 rounded" ${isChecked ? 'checked' : ''}>
                            <label for="p-${p.id}" class="text-sm text-gray-700 font-medium select-none cursor-pointer">${p.name} (${p.type})</label>
                        </div>
                        ${extraInputs}
                    `;
                    listDiv.appendChild(div);
                });
                details.appendChild(summary);
                details.appendChild(listDiv);
                els.participantList.appendChild(details);
            });
        }

        // è»Šãƒªã‚¹ãƒˆ
        function renderCarList() {
            els.carList.innerHTML = '';
            AVAILABLE_CARS_INFO.forEach(car => {
                const isChecked = selectedCarIds.has(car.id);
                const hasLuggage = selectedLuggage.has(car.id);
                const driverId = selectedDrivers.get(car.id) || '';
                
                // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å€™è£œ
                const family = FAMILIES.find(f => f.familyName === car.familyName);
                const candidates = family ? family.members : ALL_PARTICIPANTS_FLAT;
                const options = candidates.filter(p => p.type !== 'é¸æ‰‹' && p.type !== 'å…„å¼Ÿ')
                                          .map(p => `<option value="${p.id}" ${driverId === p.id ? 'selected' : ''}>${p.name}</option>`)
                                          .join('');

                const div = document.createElement('div');
                div.className = `p-3 rounded border ${isChecked ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'}`;
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input type="checkbox" id="c-${car.id}" data-id="${car.id}" class="car-check mr-2 h-5 w-5 text-blue-600 rounded" ${isChecked ? 'checked' : ''}>
                            <label for="c-${car.id}" class="font-bold text-gray-800 cursor-pointer">${car.name}</label>
                        </div>
                        <span class="text-xs text-gray-500">å®šå“¡ ${car.baseCapacity}å</span>
                    </div>
                    <div class="mt-2 pl-7 space-y-2 ${isChecked ? '' : 'hidden'}" id="car-opt-${car.id}">
                        <select data-car-id="${car.id}" class="driver-select w-full text-sm p-1 border rounded shadow-sm bg-white">
                            <option value="">(ãƒ‰ãƒ©ã‚¤ãƒãƒ¼é¸æŠ)</option>
                            ${options}
                        </select>
                        <div class="flex items-center">
                            <input type="checkbox" id="lug-${car.id}" data-car-id="${car.id}" class="luggage-check mr-2 text-blue-600 rounded" ${hasLuggage ? 'checked' : ''}>
                            <label for="lug-${car.id}" class="text-xs text-gray-700 select-none cursor-pointer">è·ç‰©ã‚ã‚Š (å®šå“¡ã‚’2åã«åˆ¶é™)</label>
                        </div>
                    </div>
                `;
                els.carList.appendChild(div);
            });
        }

        // åˆ¥ä¾¿ãƒªã‚¹ãƒˆ
        function renderExclusionList() {
            els.exclusionList.innerHTML = '';
            const targets = ALL_PARTICIPANTS_FLAT.filter(p => selectedParticipantIds.has(p.id));
            if(targets.length === 0) {
                els.exclusionList.innerHTML = '<span class="text-gray-400 text-sm">å‚åŠ è€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>';
                return;
            }
            targets.forEach(p => {
                const isExcluded = excludedParticipantIds.has(p.id);
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="flex items-center space-x-2 cursor-pointer p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" data-id="${p.id}" class="exclusion-check text-red-500 rounded" ${isExcluded ? 'checked' : ''}>
                        <span class="text-sm ${isExcluded ? 'text-gray-400 line-through' : 'text-gray-700'}">${p.name}</span>
                    </label>
                `;
                els.exclusionList.appendChild(div);
            });
        }

        // â˜…â˜…â˜… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜…
        function updateStatusCounter() {
            // å‚åŠ äºˆå®šäººæ•° (åˆ¥ä¾¿ã‚’é™¤ã)
            const participants = Array.from(selectedParticipantIds).filter(id => !excludedParticipantIds.has(id)).length;
            
            // è»Šã®ç·å®šå“¡
            let capacity = 0;
            selectedCarIds.forEach(carId => {
                const car = AVAILABLE_CARS_INFO.find(c => c.id === carId);
                if (car) {
                    // è·ç‰©ã‚ã‚Šãªã‚‰2å(ãƒ‰ãƒ©ã‚¤ãƒãƒ¼+1)ã€ãªã—ãªã‚‰åŸºæœ¬å®šå“¡
                    capacity += selectedLuggage.has(carId) ? 2 : car.baseCapacity;
                }
            });

            const balance = capacity - participants;

            els.statusParticipants.textContent = participants;
            els.statusCapacity.textContent = capacity;
            els.statusBalance.textContent = balance;

            // ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
            els.statusBar.className = `border rounded-lg shadow p-3 mb-6 flex flex-col md:flex-row justify-between items-center sticky top-0 z-40 transition-colors duration-300`;
            if (balance < 0) {
                els.statusBar.classList.add('warning', 'bg-red-50', 'border-red-300');
            } else {
                els.statusBar.classList.add('safe', 'bg-green-50', 'border-green-300');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
        function setupEventListeners() {
            // å‚åŠ è€…ãƒã‚§ãƒƒã‚¯
            els.participantList.addEventListener('click', e => {
                const btn = e.target.closest('button[data-action]');
                if (btn) {
                    // å…¨é¸æŠãƒ»å…¨è§£é™¤
                    const familyName = btn.dataset.family;
                    const family = FAMILIES.find(f => f.familyName === familyName);
                    if (family) {
                        const shouldCheck = btn.dataset.action === 'check-all';
                        family.members.forEach(m => {
                            if(shouldCheck) selectedParticipantIds.add(m.id);
                            else selectedParticipantIds.delete(m.id);
                        });
                        renderParticipantList();
                        renderExclusionList();
                        updateStatusCounter();
                    }
                    return;
                }

                if (e.target.classList.contains('participant-check')) {
                    const id = e.target.dataset.id;
                    if (e.target.checked) selectedParticipantIds.add(id);
                    else {
                        selectedParticipantIds.delete(id);
                        excludedParticipantIds.delete(id); // å‚åŠ ã‚„ã‚ã‚‹ãªã‚‰åˆ¥ä¾¿ã‹ã‚‰ã‚‚æ¶ˆã™
                    }
                    renderParticipantList(); // å±æ€§æ¬„ã®disabledåˆ‡ã‚Šæ›¿ãˆã®ãŸã‚å†æç”»
                    renderExclusionList();
                    updateStatusCounter();
                }
            });

            // å±æ€§å…¥åŠ›
            els.participantList.addEventListener('input', e => {
                if (e.target.dataset.type) {
                    const id = e.target.dataset.id;
                    const type = e.target.dataset.type;
                    const data = participantData.get(id) || {};
                    data[type] = e.target.value;
                    participantData.set(id, data);
                }
            });

            // è»Šé¸æŠ
            els.carList.addEventListener('change', e => {
                if (e.target.classList.contains('car-check')) {
                    const id = e.target.dataset.id;
                    if(e.target.checked) selectedCarIds.add(id);
                    else {
                        selectedCarIds.delete(id);
                        selectedLuggage.delete(id);
                        selectedDrivers.delete(id);
                    }
                    renderCarList();
                    updateStatusCounter();
                }
                if (e.target.classList.contains('driver-select')) {
                    const carId = e.target.dataset.carId;
                    if (e.target.value) selectedDrivers.set(carId, e.target.value);
                    else selectedDrivers.delete(carId);
                }
                if (e.target.classList.contains('luggage-check')) {
                    const carId = e.target.dataset.carId;
                    if(e.target.checked) selectedLuggage.add(carId);
                    else selectedLuggage.delete(carId);
                    updateStatusCounter();
                }
            });

            // åˆ¥ä¾¿
            els.exclusionList.addEventListener('change', e => {
                if (e.target.classList.contains('exclusion-check')) {
                    const id = e.target.dataset.id;
                    if(e.target.checked) excludedParticipantIds.add(id);
                    else excludedParticipantIds.delete(id);
                    updateStatusCounter();
                }
            });

            // å‰²ã‚Šå½“ã¦å®Ÿè¡Œ
            els.assignButton.addEventListener('click', () => {
                // DOMã‹ã‚‰æœ€æ–°æƒ…å ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´
                getInputsFromDOM(); 
                // ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ (index.htmlã¨åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨)
                executeAssignment();
            });

            // ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›
            document.getElementById('show-text-output-button').addEventListener('click', () => {
                els.textOutputContainer.classList.toggle('hidden');
                updateTextOutput();
            });
            document.getElementById('copy-text-output-button').addEventListener('click', () => {
                navigator.clipboard.writeText(els.textOutput.value);
                alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
            
            // DBæ“ä½œãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠ (ç°¡æ˜“å®Ÿè£…)
            document.getElementById('save-state-db-button').addEventListener('click', handleSaveState);
            document.getElementById('load-state-db-button').addEventListener('click', handleLoadState);
            document.getElementById('delete-state-db-button').addEventListener('click', handleDeleteState);
            // ... (ä»–ãƒœã‚¿ãƒ³ã‚‚åŒæ§˜ã ãŒçœç•¥)
        }

        // --- DOMå…¥åŠ›å€¤å–å¾— ---
        function getInputsFromDOM() {
            eventInfo = {
                date: els.eventDate.value,
                name: els.eventName.value,
                timeline: els.eventTimeline.value,
                notes: els.eventNotes.value
            };
            parkingInfo = {
                groundName: els.groundName.value,
                designated: { 
                    name: els.pDesName.value || 'æŒ‡å®šé§è»Šå ´', 
                    limit: parseInt(els.pDesLimit.value)||999, 
                    memo: els.pDesMemo.value 
                },
                other: {
                    name: els.pOtherName.value || 'æŒ‡å®šé§è»Šå ´ä»¥å¤–',
                    memo: els.pOtherMemo.value
                }
            };
        }

        // --- å‰²ã‚Šå½“ã¦ãƒ­ã‚¸ãƒƒã‚¯ (Core) ---
        function executeAssignment() {
            // ç°¡æ˜“ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (selectedCarIds.size === 0) {
                alert('è»Šã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
            let cars = [];
            let driverIds = new Set();

            // è»Šãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
            selectedCarIds.forEach(carId => {
                const info = AVAILABLE_CARS_INFO.find(c => c.id === carId);
                const driverId = selectedDrivers.get(carId);
                const hasLuggage = selectedLuggage.has(carId);
                const driver = ALL_PARTICIPANTS_FLAT.find(p => p.id === driverId);
                
                if(driver) driverIds.add(driver.id);

                // å®šå“¡è¨ˆç®—
                let cap = hasLuggage ? 1 : info.baseCapacity - 1; // ä¹—å“¡æ•° (ãƒ‰ãƒ©ã‚¤ãƒãƒ¼é™¤ã)
                let baseCap = hasLuggage ? 2 : info.baseCapacity;

                cars.push({
                    id: carId,
                    name: info.name,
                    driver: driver,
                    members: [], // ã“ã“ã«äººã‚’è©°ã‚ã‚‹
                    capacity: cap,
                    baseCapacity: baseCap,
                    hasLuggage: hasLuggage,
                    assignedParking: 'other' // ä»®
                });
            });

            // ä¹—è»Šå¯¾è±¡è€… (ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ä»¥å¤–ã€åˆ¥ä¾¿ä»¥å¤–)
            let passengers = ALL_PARTICIPANTS_FLAT.filter(p => 
                selectedParticipantIds.has(p.id) && 
                !driverIds.has(p.id) && 
                !excludedParticipantIds.has(p.id)
            );
            
            // å®šå“¡ãƒã‚§ãƒƒã‚¯
            const totalCap = cars.reduce((sum, c) => sum + c.capacity, 0);
            if (passengers.length > totalCap) {
                alert(`å®šå“¡ã‚ªãƒ¼ãƒãƒ¼ã§ã™ï¼ (ä¹—å®¢:${passengers.length}å / ç©ºã:${totalCap}å)`);
                // ç¶šè¡Œã¯ã™ã‚‹
            }

            // â˜… å‰²ã‚Šå½“ã¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (index.htmlã¨åŒç­‰) â˜…
            // 1. å®¶æ—åŒä¹—
            // 2. æ®‹ã‚Šã‚’ãƒ©ãƒ³ãƒ€ãƒ  (åŒä¹—å„ªå…ˆãƒ•ãƒ©ã‚°è€ƒæ…®)
            
            // (1) å®¶æ—åŒä¹—
            let remaining = [...passengers];
            cars.forEach(car => {
                if(!car.driver) return;
                const familyName = car.driver.familyName || FAMILIES.find(f => f.members.some(m=>m.id===car.driver.id))?.familyName;
                if(!familyName) return;

                const familyMembers = remaining.filter(p => {
                    const f = FAMILIES.find(fam => fam.members.some(m => m.id === p.id));
                    return f && f.familyName === familyName;
                });

                familyMembers.forEach(m => {
                    if(car.members.length < car.capacity) {
                        car.members.push(m);
                        remaining = remaining.filter(r => r.id !== m.id);
                    }
                });
            });

            // (2) æ®‹ã‚Šã‚’å‰²ã‚ŠæŒ¯ã‚‹ (ç°¡æ˜“å®Ÿè£…: ãƒ©ãƒ³ãƒ€ãƒ )
            // æœ¬æ¥ã¯å­¦å¹´ã‚„å­¦æ ¡ã®ä¸€è‡´ã‚’è¦‹ã‚‹ãŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ç©ºã„ã¦ã„ã‚‹è»Šã«è©°ã‚ã‚‹
            remaining.forEach(p => {
                // ç©ºãã®ã‚ã‚‹è»Šã‚’æ¢ã™
                const car = cars.find(c => c.members.length < c.capacity);
                if(car) {
                    car.members.push(p);
                } else {
                    // ã‚ãµã‚ŒãŸäºº (åˆ¥ä¾¿æ‰±ã„ã«ã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã™ã‚‹ã‹)
                    // ã“ã“ã§ã¯ã€Œåˆ¥ä¾¿ã€ç”¨ã®ä»®æƒ³è»Šã«å…¥ã‚Œã‚‹
                }
            });

            // é§è»Šå ´å‰²ã‚ŠæŒ¯ã‚Š
            let count = 0;
            cars.forEach(c => {
                if (count < parkingInfo.designated.limit) {
                    c.assignedParking = 'designated';
                    count++;
                } else {
                    c.assignedParking = 'other';
                }
            });
            
            // åˆ¥ä¾¿è»Šã‚’ä½œæˆ
            const excludedMembers = ALL_PARTICIPANTS_FLAT.filter(p => excludedParticipantIds.has(p.id));
            if (excludedMembers.length > 0 || remaining.length > 0) {
                // ã‚ãµã‚ŒãŸäººã‚‚ã“ã“ã«è¿½åŠ 
                /* const overflow = remaining.filter(p => !cars.some(c => c.members.includes(p))); */ // ä¸Šè¨˜ã§pushæ¸ˆã¿ãªã‚‰ä¸è¦ã ãŒ
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
            currentAssignments = cars;
            
            // æç”»
            renderResults();
            
            // çµæœãŒå‡ºãŸã‚‰Fabè¡¨ç¤º
            document.getElementById('fab-text-output').classList.remove('hidden');
        }

        // --- â˜…â˜…â˜… çµæœæç”» & SortableJS åˆæœŸåŒ– â˜…â˜…â˜… ---
        function renderResults() {
            const container = els.results;
            container.innerHTML = '';

            if (currentAssignments.length === 0) return;

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º (ã‚¤ãƒ™ãƒ³ãƒˆåãªã©)
            const title = document.createElement('h3');
            title.className = 'text-lg font-bold text-gray-800 mb-2';
            title.textContent = `${eventInfo.date} ${eventInfo.name} ${parkingInfo.groundName ? '@'+parkingInfo.groundName : ''}`;
            container.appendChild(title);

            // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ (æŒ‡å®š / æŒ‡å®šå¤– / åˆ¥ä¾¿)
            const groups = [
                { key: 'designated', label: `â—†${parkingInfo.designated.name} (åˆ¶é™${parkingInfo.designated.limit}å°)`, memo: parkingInfo.designated.memo },
                { key: 'other', label: `â—†${parkingInfo.other.name}`, memo: parkingInfo.other.memo },
                { key: 'excluded', label: 'â—†åˆ¥ä¾¿ãƒ»ã‚ãµã‚Œ', memo: '' }
            ];

            groups.forEach(g => {
                const groupCars = (g.key === 'excluded') 
                    ? [] // åˆ¥ä¾¿ã¯åˆ¥é€”å‡¦ç†ã—ãŸã„ãŒã€DnDã®ãŸã‚ã«ã€Œåˆ¥ä¾¿ã¨ã„ã†åã®è»Šã€ã‚’ä½œã‚‹æ‰‹ã‚‚ã‚ã‚‹ã€‚ä»Šå›ã¯ç°¡æ˜“çš„ã«é™¤å¤–è€…ã¯ãƒªã‚¹ãƒˆè¡¨ç¤ºã®ã¿ã«ã™ã‚‹ã‹ï¼Ÿ
                    : currentAssignments.filter(c => c.assignedParking === g.key);
                
                // åˆ¥ä¾¿ã‚«ãƒ¼(ä»®æƒ³)ã®å‡¦ç†
                if(g.key === 'excluded') {
                     const excludedMembers = ALL_PARTICIPANTS_FLAT.filter(p => excludedParticipantIds.has(p.id));
                     // ã‚ãµã‚ŒãŸäººãŒã„ã‚Œã°ã“ã“ã«è¿½åŠ ã—ãŸã„ãŒã€currentAssignmentsã«å«ã¾ã‚Œãªã„ã®ã§åˆ¥é€”ç®¡ç†ãŒå¿…è¦ã€‚
                     // ç°¡æ˜“åŒ–ã®ãŸã‚ã€ä»Šå›ã¯ excludedParticipantIds ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
                     if (excludedMembers.length > 0) {
                         groupCars.push({
                             id: 'excluded_car',
                             name: 'åˆ¥ä¾¿',
                             driver: null,
                             members: excludedMembers,
                             capacity: 999,
                             baseCapacity: 999,
                             isExcluded: true
                         });
                     }
                }

                if (groupCars.length === 0) return;

                const section = document.createElement('div');
                section.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4';
                
                section.innerHTML = `<h4 class="font-bold text-gray-700">${g.label}</h4><p class="text-xs text-gray-500 mb-3 whitespace-pre-wrap">${g.memo}</p>`;
                
                const grid = document.createElement('div');
                grid.className = 'results-grid-layout'; // grid gap-4 etc

                groupCars.forEach(car => {
                    const carCard = createCarCardElement(car);
                    grid.appendChild(carCard);
                });
                
                section.appendChild(grid);
                container.appendChild(section);
            });

            // â˜… SortableJS ã®åˆæœŸåŒ–
            initSortable();
            updateTextOutput();
        }

        function createCarCardElement(car) {
            const card = document.createElement('div');
            card.className = 'bg-slate-50 border rounded-lg overflow-hidden shadow-sm flex flex-col';
            card.dataset.carId = car.id;
            card.dataset.capacity = car.baseCapacity; // ç·å®šå“¡
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = document.createElement('div');
            header.className = 'p-3 bg-slate-200 border-b flex justify-between items-center';
            header.innerHTML = `<span class="font-bold text-sm">${car.name}</span> <span class="text-xs bg-white px-1 rounded text-slate-500">å®šå“¡${car.baseCapacity}</span>`;
            card.appendChild(header);

            // ãƒœãƒ‡ã‚£
            const body = document.createElement('div');
            body.className = 'p-2 flex-1 flex flex-col gap-2';

            // 1. ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚¨ãƒªã‚¢ (Dropzone)
            const driverZone = document.createElement('div');
            driverZone.className = 'driver-dropzone min-h-[40px] border-2 border-dashed border-blue-200 rounded bg-blue-50 p-1';
            driverZone.dataset.role = 'driver';
            driverZone.dataset.carId = car.id;
            
            if (car.driver) {
                driverZone.appendChild(createMemberElement(car.driver, true));
            } else {
                driverZone.innerHTML = '<span class="text-xs text-blue-300 p-1">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</span>';
            }
            body.appendChild(driverZone);

            // 2. ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ (Dropzone)
            const memberList = document.createElement('ul');
            memberList.className = 'members-dropzone space-y-1 min-h-[60px] flex-1';
            memberList.dataset.role = 'member';
            memberList.dataset.carId = car.id;
            // å®šå“¡ãƒã‚§ãƒƒã‚¯ç”¨
            // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ãŒã„ã‚‹å ´åˆã¯ã€æ®‹ã‚Šå®šå“¡ = baseCapacity - 1
            // ã„ãªã„å ´åˆã¯ baseCapacity (ãŸã ã—ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ ã¯åˆ¥ãªã®ã§ã€ã“ã“ã¯ã‚ãã¾ã§å¾Œéƒ¨åº§å¸­æ•°)
            // ç°¡æ˜“åŒ–: memberListã«ã¯ä½•äººã§ã‚‚å…¥ã‚‹ãŒã€Moveã‚¤ãƒ™ãƒ³ãƒˆã§åˆ¶é™ã™ã‚‹
            
            car.members.forEach(m => {
                if(m) memberList.appendChild(createMemberElement(m, false));
            });
            
            body.appendChild(memberList);
            card.appendChild(body);

            return card;
        }

        function createMemberElement(member, isDriver) {
            const li = document.createElement('li');
            li.className = `draggable-item p-2 rounded shadow-sm text-sm flex justify-between items-center ${isDriver ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border'}`;
            li.dataset.id = member.id;
            
            const memo = participantData.get(member.id)?.memo || '';
            const memoHtml = memo ? `<span class="text-xs opacity-70 ml-1">[${memo}]</span>` : '';
            
            li.innerHTML = `
                <span>${member.name} ${memoHtml}</span>
                <span class="text-xs opacity-50">${member.type.substr(0,1)}</span>
            `;
            return li;
        }

        // --- SortableJS åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆåˆ¶å¾¡ ---
        function initSortable() {
            // 1. ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚¾ãƒ¼ãƒ³
            const driverZones = document.querySelectorAll('.driver-dropzone');
            driverZones.forEach(el => {
                new Sortable(el, {
                    group: 'shared', // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã¨å…±æœ‰
                    animation: 150,
                    max: 1, // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯1äººã¾ã§
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onAdd: (evt) => handleDrop(evt),
                    onRemove: (evt) => handleDrop(evt),
                });
            });

            // 2. ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ
            const memberZones = document.querySelectorAll('.members-dropzone');
            memberZones.forEach(el => {
                const carId = el.dataset.carId;
                const car = currentAssignments.find(c => c.id === carId);
                const isExcludedCar = (carId === 'excluded_car');
                
                // ä¹—å“¡å®šå“¡ (ãƒ‰ãƒ©ã‚¤ãƒãƒ¼æ ã‚’é™¤ã)
                // è·ç‰©ã‚ã‚Šè»Š(ç·å®šå“¡2)ã®å ´åˆã€ãƒ‰ãƒ©ã‚¤ãƒãƒ¼1 + ãƒ¡ãƒ³ãƒãƒ¼1
                let memberCapacity = 999;
                if (!isExcludedCar && car) {
                    // hasLuggageãªã‚‰ capacityã¯1(ãƒ¡ãƒ³ãƒãƒ¼æ )ã€‚
                    // baseCapacityã‹ã‚‰ãƒ‰ãƒ©ã‚¤ãƒãƒ¼(1)ã‚’å¼•ã„ãŸæ•°
                    memberCapacity = car.capacity; // executeAssignmentã§è¨ˆç®—ã—ãŸã€Œä¹—å®¢å®šå“¡ã€
                }

                new Sortable(el, {
                    group: 'shared',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    
                    // ç§»å‹•æ™‚ã®åˆ¶é™ (å®šå“¡ãƒã‚§ãƒƒã‚¯)
                    onMove: function (evt, originalEvent) {
                        if (isExcludedCar) return true; // åˆ¥ä¾¿ã¯ç„¡åˆ¶é™

                        const targetList = evt.to;
                        const targetCount = targetList.children.length; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦ç´ ã¯å«ã¾ã‚Œãªã„ï¼Ÿã„ã‚„å«ã¾ã‚Œã‚‹
                        // SortableJSã®ä»•æ§˜: evt.related ã¯å…¥ã‚Œæ›¿ãˆå¯¾è±¡ã€‚
                        // å˜ç´”ã«ã€ç§»å‹•å…ˆã®ãƒªã‚¹ãƒˆã®è¦ç´ æ•°ãŒå®šå“¡ã«é”ã—ã¦ã„ãŸã‚‰æ‹’å¦ã™ã‚‹
                        // ãŸã ã—ã€Œè‡ªåˆ†ãŒå‡ºã¦ã„ãã€ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã ãŒã€
                        // åˆ¥ã®ãƒªã‚¹ãƒˆã¸ã®ç§»å‹•(Add)ã®å¯å¦åˆ¤å®šãŒä¸»ã€‚
                        
                        // to ãŒè‡ªåˆ†è‡ªèº«ãªã‚‰OK
                        if (evt.to === evt.from) return true;

                        // ç§»å‹•å…ˆãŒãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚¾ãƒ¼ãƒ³ã®å ´åˆã¯ max:1 è¨­å®šãŒåŠ¹ãã®ã§ã“ã“ã§ã¯æ°—ã«ã—ãªã„
                        if (evt.to.classList.contains('driver-dropzone')) return true;

                        // ç§»å‹•å…ˆãŒãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®å ´åˆã€å®šå“¡ãƒã‚§ãƒƒã‚¯
                        // evt.to.children ã«ã¯ã€ã‚´ãƒ¼ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã®æ•° + 1 (ä»Šå…¥ã‚ã†ã¨ã—ã¦ã„ã‚‹è‡ªåˆ†) ã«ãªã‚‹ã¯ãš
                        // æ­£ç¢ºã«ã¯ã€Œä»Šå…¥ã£ã¦ã„ã‚‹æ•°ã€ã‚’å–å¾—ã—ã€ãã‚ŒãŒ capacity ä»¥ä¸Šãªã‚‰ NG
                        // SortableJS ã® onMove ã¯ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ä½•åº¦ã‚‚ç™ºç«ã™ã‚‹
                        
                        if (targetCount >= memberCapacity) {
                            return false; // æ‹’å¦ (èµ¤ããªã‚‹)
                        }
                        return true;
                    },
                    
                    onAdd: (evt) => handleDrop(evt),
                    onRemove: (evt) => handleDrop(evt),
                    onEnd: (evt) => {
                        // åŒã˜ãƒªã‚¹ãƒˆå†…ã§ã®ä¸¦ã³æ›¿ãˆã‚‚ã“ã“ã§æ¤œçŸ¥
                        updateAssignmentsFromDOM(); 
                    }
                });
            });
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ç™ºç”Ÿæ™‚ã®å‡¦ç†
        function handleDrop(evt) {
            // DOMã¯æ—¢ã«æ›¸ãæ›ã‚ã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’è¦‹ã¦å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã™ã‚‹
            updateAssignmentsFromDOM();
            // å¿…è¦ãªã‚‰å†æç”»ã™ã‚‹ãŒã€SortableJSãŒDOMã‚’ã„ã˜ã£ãŸç›´å¾Œãªã®ã§
            // å…¨å†æç”»ã™ã‚‹ã¨ãƒ‰ãƒ©ãƒƒã‚°ã®ä½™éŸ»ãŒæ¶ˆãˆã‚‹ã€‚
            // ã“ã“ã§ã¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›æ›´æ–°ã ã‘ã«ã™ã‚‹ã€‚
            updateTextOutput();
        }

        // DOMã®çŠ¶æ…‹ã‚’æ­£ã¨ã—ã¦ currentAssignments ã‚’å†æ§‹ç¯‰ã™ã‚‹
        function updateAssignmentsFromDOM() {
            const carCards = document.querySelectorAll('[data-car-id]');
            
            carCards.forEach(card => {
                const carId = card.dataset.carId;
                // åˆ¥ä¾¿ãƒªã‚¹ãƒˆã®å ´åˆã®å‡¦ç†
                if (carId === 'excluded_car') {
                    // ç°¡æ˜“å¯¾å¿œ: excludedParticipantIds ã‚’æ›´æ–°ã™ã‚‹
                    const memberList = card.querySelector('.members-dropzone');
                    if(memberList) {
                        memberList.querySelectorAll('li').forEach(li => {
                            excludedParticipantIds.add(li.dataset.id);
                        });
                    }
                    return;
                }

                const carData = currentAssignments.find(c => c.id === carId);
                if (!carData) return;

                // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼å–å¾—
                const driverZone = card.querySelector('.driver-dropzone');
                const driverLi = driverZone.querySelector('li');
                if (driverLi) {
                    const pId = driverLi.dataset.id;
                    carData.driver = ALL_PARTICIPANTS_FLAT.find(p => p.id === pId);
                } else {
                    carData.driver = null;
                }

                // ãƒ¡ãƒ³ãƒãƒ¼å–å¾—
                const memberList = card.querySelector('.members-dropzone');
                const members = [];
                memberList.querySelectorAll('li').forEach(li => {
                    const pId = li.dataset.id;
                    const p = ALL_PARTICIPANTS_FLAT.find(x => x.id === pId);
                    if(p) members.push(p);
                });
                carData.members = members;
            });
            
            // åˆ¥ä¾¿ã‹ã‚‰ç§»å‹•ã—ã¦ããŸäººãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€
            // å…¨è»Šã‚’è¦‹ã¦ã€ãã“ã«ã„ã‚‹äººã¯ excludedParticipantIds ã‹ã‚‰æ¶ˆã™å¿…è¦ãŒã‚ã‚‹
            // ... (å³å¯†ãªæ•´åˆæ€§ç¢ºä¿ã¯è¤‡é›‘ã ãŒã€è¡¨ç¤ºä¸Šã¯DOMå„ªå…ˆã§OK)
        }
        
        // --- ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ› (index.htmlã‹ã‚‰ç§»æ¤) ---
        function updateTextOutput() {
            if(currentAssignments.length === 0) return;
            
            let lines = [];
            const ground = parkingInfo.groundName ? `@${parkingInfo.groundName}` : '';
            lines.push(`${eventInfo.date} ${eventInfo.name} ${ground}`);
            if(eventInfo.timeline) lines.push(`\n${eventInfo.timeline}`);

            // æŒ‡å®šP
            const desCars = currentAssignments.filter(c => c.assignedParking === 'designated');
            if(desCars.length > 0) {
                lines.push(`\nâ—†${parkingInfo.designated.name} (åˆ¶é™${parkingInfo.designated.limit}å°)`);
                if(parkingInfo.designated.memo) lines.push(parkingInfo.designated.memo);
                desCars.forEach(c => lines.push(getCarLine(c)));
            }
            
            // æŒ‡å®šå¤–P
            const otherCars = currentAssignments.filter(c => c.assignedParking === 'other');
            if(otherCars.length > 0) {
                lines.push(`\nâ—†${parkingInfo.other.name}`);
                if(parkingInfo.other.memo) lines.push(parkingInfo.other.memo);
                otherCars.forEach(c => lines.push(getCarLine(c)));
            }

            // åˆ¥ä¾¿ (DOMã‹ã‚‰å–å¾—ã—ãŸã»ã†ãŒæ­£ç¢º)
            // ...
            
            if(eventInfo.notes) lines.push(`\nâ—†ãã®ä»–\n${eventInfo.notes}`);

            els.textOutput.value = lines.join('\n');
        }

        function getCarLine(car) {
            const carName = car.name.replace(/ã®è»Š|å®¶ã®è»Š/g, 'ã‚«ãƒ¼');
            let parts = [];
            if(car.driver) parts.push(car.driver.name + getMemo(car.driver.id));
            else parts.push('(Dræœªå®š)');
            
            car.members.forEach(m => {
                parts.push((m.type==='é¸æ‰‹'?'â˜…':'') + m.name + getMemo(m.id));
            });
            if(car.hasLuggage) parts.push('è·ç‰©');
            
            return `ãƒ»${carName} (${parts.join(', ')})`;
        }
        
        function getMemo(id) {
            const m = participantData.get(id)?.memo;
            return m ? `[${m}]` : '';
        }

        // --- DBä¿å­˜ãªã©ã¯ãƒœã‚¿ãƒ³IDãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ ---
        function handleSaveState() { /* ...index.htmlã¨åŒæ§˜ã®å®Ÿè£…... */ alert('ä¿å­˜ã—ã¾ã—ãŸ(ãƒ¢ãƒƒã‚¯)'); }
        function handleLoadState() { /* ... */ }
        function handleDeleteState() { /* ... */ }
        function showMessage(msg, type) {
            els.messageText.textContent = msg;
            els.messageContainer.classList.remove('hidden');
            setTimeout(() => els.messageContainer.classList.add('hidden'), 3000);
        }

    </script>
</body>
</html>